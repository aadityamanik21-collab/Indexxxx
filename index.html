<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f8fafc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Zenith Glorious</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { glass: 'rgba(255, 255, 255, 0.7)', glassBorder: 'rgba(255, 255, 255, 0.5)' }
                }
            }
        }
    </script>

    <style>
        /* --- CORE RESET & LAYOUT --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, hsla(210, 40%, 96%, 1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(220, 30%, 94%, 1) 0, transparent 50%);
            height: 100vh;
            height: 100dvh; 
            overflow-y: auto; overflow-x: hidden;
            color: #0f172a; position: relative;
            padding-bottom: 120px;
        }

        .scroller { overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; -ms-overflow-style: none; }
        .scroller::-webkit-scrollbar { display: none; }

        .draggable-item { cursor: grab; user-select: none; -webkit-user-select: none; transition: transform 0.2s, box-shadow 0.2s; }
        .draggable-item.dragging { opacity: 0.5; transform: scale(0.98); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); cursor: grabbing; border: 2px dashed #3b82f6; }
        .drag-over { border-top: 3px solid #3b82f6; }

        input, select { -webkit-appearance: none; appearance: none; }
        input[type="date"], input[type="time"], input[type="text"], input[type="number"] { -webkit-appearance: none; appearance: none; }

        #season-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 60; overflow: hidden; }
        .snowflake { position: absolute; top: -30px; color: #bae6fd; text-shadow: 0 0 5px rgba(186, 230, 253, 0.5); animation: snow-fall linear infinite; }
        @keyframes snow-fall { 0% { transform: translateY(0) translateX(0); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(110vh) translateX(20px); opacity: 0.6; } }
        
        .glorious-text {
            background: linear-gradient(110deg, #14532d 0%, #166534 25%, #84cc16 50%, #166534 75%, #14532d 100%);
            background-size: 200% auto;
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 4s linear infinite; filter: drop-shadow(0 2px 4px rgba(22, 101, 52, 0.15));
            letter-spacing: -0.04em;
        }
        @keyframes shine { to { background-position: 200% center; } }

        /* SUCCESS POPUP */
        #success-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 20px 40px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); text-align: center; z-index: 1000; opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); border: 2px solid #bbf7d0; }
        #success-popup.active { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .success-icon { font-size: 40px; color: #22c55e; margin-bottom: 10px; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }

                /* --- LIQUID GLASS COMPONENTS --- */
        .glass { 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.1) 100%); 
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); 
            border: 1px solid rgba(255, 255, 255, 0.4); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.05), inset 0 1px 1px rgba(255,255,255,0.9), inset 0 -1px 2px rgba(255,255,255,0.3); 
            border-radius: 24px; position: relative; z-index: 10; 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease; 
        }
        .glass-nav { 
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 400px; height: 52px; 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.5) 0%, rgba(255, 255, 255, 0.15) 100%); 
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); 
            border-radius: 26px; border: 1px solid rgba(255, 255, 255, 0.4); 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.15), inset 0 1px 2px rgba(255,255,255,0.9), inset 0 -1px 2px rgba(255,255,255,0.2); 
            z-index: 50; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; 
        }

        
        /* Input Refinement */
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], select { transition: all 0.2s; border: 1px solid #e2e8f0; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        input:focus, select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), inset 0 2px 4px rgba(0,0,0,0.02); outline: none; }
        
        .cal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 8px; }
        .cal-day-box { background: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.7); border-radius: 14px; padding: 8px; height: 150px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; }
        .is-today { border: 2px solid #3b82f6; background: white; }
        .cal-slots { display: flex; flex-direction: column; gap: 3px; flex: 1; overflow: hidden; }
        .slot { height: 16px; border-radius: 4px; font-size: 9px; font-weight: 700; display: flex; align-items: center; padding: 0 4px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .slot-empty { background: rgba(0,0,0,0.05); }

        /* --- QUARTER BOARD --- */
        .board-container { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 20px; snap-type: x mandatory; }
        .board-col { min-width: 260px; width: 85vw; max-width: 300px; background: rgba(255,255,255,0.5); border-radius: 16px; border: 1px solid rgba(255,255,255,0.6); display: flex; flex-direction: column; snap-align: center; }
        .board-header { padding: 12px; font-weight: 800; font-size: 14px; color: #475569; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .board-items { padding: 8px; flex: 1; overflow-y: auto; min-height: 200px; }
        .board-card { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 8px; border: 1px solid #f1f5f9; cursor: grab; }
        .board-card:active { cursor: grabbing; transform: rotate(1deg); }
        .q-tag { font-size: 9px; font-weight: 900; padding: 2px 6px; border-radius: 4px; background: #e0f2fe; color: #0284c7; }

        .tap-scale { transition: transform 0.1s; } .tap-scale:active { transform: scale(0.96); }
        .nav-btn.active { color: #2563eb; } .nav-indicator { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%) scaleX(0); width: 24px; height: 3px; background: #2563eb; border-radius: 10px; transition: transform 0.2s; }
        .nav-btn.active .nav-indicator { transform: translateX(-50%) scaleX(1); }
        .bento-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; } .bento-wide { grid-column: span 2; }
        
        .group-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: #eff6ff; border-radius: 12px; margin: 12px 0 8px 0; cursor: pointer; border: 1px solid #dbeafe; }
        .group-header:active { background: #dbeafe; }
        .group-title { font-weight: 800; font-size: 11px; text-transform: uppercase; color: #3b82f6; letter-spacing: 0.5px; }

        .streak-btn { padding: 4px 10px; background: #fff7ed; border: 1px solid #ffedd5; color: #ea580c; border-radius: 20px; font-size: 11px; font-weight: 800; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .streak-btn:active { transform: scale(0.95); background: #ffedd5; }
        .streak-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 10px; margin-bottom: 8px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 110; display: none; align-items: flex-end; }
        .modal-overlay.open { display: flex; }
        .modal { width: 100%; background: #fff; border-radius: 24px 24px 0 0; padding: 24px; animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .fab { position: fixed; bottom: 100px; right: 24px; width: 64px; height: 64px; background: #0f172a; color: white; border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 16px 30px -10px rgba(15, 23, 42, 0.6), inset 0 2px 0 rgba(255,255,255,0.2); z-index: 50; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .fab:active { transform: scale(0.85) rotate(90deg); }

        /* Floating Dock (Liquid) */
        .dock-container { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6) 0%, rgba(255, 255, 255, 0.2) 100%); 
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); 
            border-radius: 30px; border: 1px solid rgba(255,255,255,0.4); 
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15), inset 0 1px 2px rgba(255,255,255,0.9), inset 0 -1px 2px rgba(255,255,255,0.3); 
            display: flex; justify-content: space-around; padding: 8px 12px; z-index: 40; 
        }
        .dock-btn { width: 60px; height: 50px; display: flex; flex-direction: column; items-center; justify-content: center; border-radius: 20px; color: #64748b; font-size: 18px; transition: all 0.2s ease; position: relative; }
        .dock-btn.active { color: #2563eb; background: #eff6ff; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.1); }
        .dock-btn .dock-lbl { font-size: 9px; font-weight: 800; margin-top: 4px; transition: opacity 0.2s; opacity: 0; position: absolute; bottom: 4px; }
        .dock-btn.active .dock-lbl { opacity: 1; }
        .dock-btn i { transition: transform 0.2s; }
        .dock-btn.active i { transform: translateY(-6px); }

        #file-viewer-modal { position: fixed; z-index: 200; display: flex; flex-direction: column; background: white; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; border: 1px solid #e2e8f0; }
        #file-viewer-modal.hidden-viewer { display: none !important; opacity: 0; transform: scale(0.95); }
        #file-viewer-modal.normal { inset: 5% 5% 20% 5%; border-radius: 16px; opacity: 1; display: flex; }
        #file-viewer-modal.maximized { inset: 0; border-radius: 0; opacity: 1; display: flex; z-index: 300; }
        #file-viewer-modal.minimized { inset: auto 20px 100px auto; width: 200px; height: 48px; border-radius: 12px; display: flex; border: 2px solid #3b82f6; }
        #file-viewer-modal.minimized .fv-content, #file-viewer-modal.minimized .fv-footer { display: none; }
        
        .fv-header { height: 48px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .fv-content { flex: 1; background: #334155; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .fv-content img { width: 100%; height: 100%; object-fit: contain; }
        .fv-content object { width: 100%; height: 100%; border: none; background: white; flex: 1; }
        .fv-footer { height: 40px; background: #eff6ff; display: flex; align-items: center; justify-content: center; border-top: 1px solid #dbeafe; }

        .file-item { border: 1px solid #f1f5f9; transition: all 0.2s; } .file-item:active { background: #f8fafc; transform: scale(0.98); }
        .preview-overlay { position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .preview-overlay.active { opacity: 1; pointer-events: auto; }
        .preview-card { width: 85%; max-width: 340px; background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.2); transform: scale(0.9) translateY(20px); transition: transform 0.3s; }
        .preview-overlay.active .preview-card { transform: scale(1) translateY(0); }

        .journal-bubble { width: 40px; height: 40px; min-width: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .note-img-wrapper { position: relative; width: 60px; height: 60px; display: inline-block; margin-right: 8px; }
        .note-img { width: 100%; height: 100%; border-radius: 12px; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .note-remove-btn { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #ef4444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: 2px solid white; }
    
        .bg-High { background: #ef4444; } .bg-Medium { background: #f59e0b; } .bg-Low { background: #3b82f6; } .bg-Event { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        #export-canvas-container { position: absolute; left: -9999px; top: -9999px; visibility: hidden; }

                /* --- RICH TEXT STYLING (Editor & Preview) --- */
      
         #j-editor, #preview-content { outline: none; line-height: 1.6; color: #334155; }
        #j-editor { min-height: 150px; font-size: 14px; }
        
        /* Apply same styles to both Editor and Preview */
        #j-editor h1, #preview-content h1 { display: block; font-size: 1.5em; font-weight: 900; margin-top: 0.6em; margin-bottom: 0.3em; color: #1e293b; letter-spacing: -0.02em; }
        #j-editor h2, #preview-content h2 { display: block; font-size: 1.25em; font-weight: 800; margin-top: 0.5em; margin-bottom: 0.25em; color: #334155; }
        #j-editor h3, #preview-content h3 { display: block; font-size: 1.1em; font-weight: 700; margin-top: 0.5em; margin-bottom: 0.25em; color: #475569; }
        
        #j-editor b, #j-editor strong, #preview-content b, #preview-content strong { font-weight: 800; color: #0f172a; }
        #j-editor i, #j-editor em, #preview-content i, #preview-content em { font-style: italic; }
        #j-editor u, #preview-content u { text-decoration: underline; text-decoration-color: #cbd5e1; text-decoration-thickness: 2px; }
        
        /* Lists */
        #j-editor ul, #preview-content ul { list-style-type: disc; padding-left: 20px; margin-bottom: 10px; }
        #j-editor ol, #preview-content ol { list-style-type: decimal; padding-left: 20px; margin-bottom: 10px; }
        #j-editor li, #preview-content li { margin-bottom: 4px; }
  
  /* --- DOPAMINE POPUPS --- */
.dopamine-text {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-size: 3rem;
    font-weight: 900;
    text-transform: uppercase;
    font-family: 'Inter', sans-serif;
    text-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 2000;
    pointer-events: none;
    animation: popText 1.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    background: linear-gradient(to bottom, #fff 0%, #e2e8f0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    stroke: 2px solid white;
}

@keyframes popText {
    0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); opacity: 0; }
    20% { transform: translate(-50%, -50%) scale(1.5) rotate(5deg); opacity: 1; }
    40% { transform: translate(-50%, -50%) scale(1.2) rotate(-5deg); opacity: 1; }
    100% { transform: translate(-50%, -150%) scale(1) rotate(0deg); opacity: 0; }
}

.flash-overlay {
    position: fixed;
    inset: 0;
    z-index: 1900;
    pointer-events: none;
    animation: flashFade 0.5s ease-out forwards;
}

@keyframes flashFade {
    0% { opacity: 0.6; }
    100% { opacity: 0; }
}
        /* --- THE VAULT (OMNITRIX ANIMATION) --- */
        .omnitrix-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 500; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .omnitrix-overlay.active { display: flex; animation: omnitrixBg 0.3s ease-out forwards; }
        
        .omnitrix-core { width: 80px; height: 80px; background: #22c55e; border-radius: 50%; border: 8px solid #1e293b; box-shadow: 0 0 20px #22c55e, inset 0 0 15px rgba(0,0,0,0.6); position: relative; display: flex; align-items: center; justify-content: center; transform: scale(0); overflow: hidden; z-index: 501; }
        .omnitrix-core::before, .omnitrix-core::after { content: ''; position: absolute; background: #1e293b; width: 100%; height: 16px; transform: rotate(45deg); }
        .omnitrix-core::after { transform: rotate(-45deg); }
        .omnitrix-overlay.active .omnitrix-core { animation: omnitrixSequence 1.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        .vault-content { opacity: 0; width: 95%; max-width: 600px; height: 85vh; background: #f8fafc; border-radius: 24px; padding: 20px; overflow-y: auto; position: absolute; box-shadow: 0 0 50px rgba(34, 197, 94, 0.2); border: 2px solid #22c55e; pointer-events: none; z-index: 502; display: flex; flex-direction: column; }
        .omnitrix-overlay.active .vault-content { animation: vaultReveal 0.5s ease-out 1.5s forwards; }

        @keyframes omnitrixSequence {
            0% { transform: scale(0) rotate(0deg); }
            30% { transform: scale(1) rotate(180deg); box-shadow: 0 0 30px #22c55e; }
            50% { transform: scale(1) rotate(180deg); box-shadow: 0 0 80px #4ade80; background: #4ade80; border-color: #0f172a;}
            80% { transform: scale(1.2) rotate(360deg); background: #fff; box-shadow: 0 0 100px #fff; }
            100% { transform: scale(25) rotate(360deg); opacity: 0; }
        }
        @keyframes vaultReveal { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; } }
        @keyframes omnitrixBg { from { backdrop-filter: blur(0px); } to { backdrop-filter: blur(15px); } }
        
        .task-stagnant { border-left: 4px solid #f97316 !important; background: linear-gradient(to right, #fff7ed, white) !important; }
        
        /* --- PREMIUM UI UPGRADES --- */
        /* Tactical Progress Bar */
        #daily-progress-container { width: 100%; height: 3px; background: rgba(0,0,0,0.05); position: absolute; bottom: 0; left: 0; overflow: hidden; }
        #daily-progress-bar { height: 100%; width: 0%; transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.5s ease; }

        /* Modal Bottom-Sheet Overhaul */
        .modal { padding: 32px 24px; box-shadow: 0 -25px 50px -12px rgba(0,0,0,0.25); position: relative; }
        .modal::before { content: ''; width: 40px; height: 5px; background: #cbd5e1; border-radius: 5px; position: absolute; top: 12px; left: 50%; transform: translateX(-50%); }
        
        /* Tactile Card Physics */
        .card { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease, border-color 0.2s ease; border: 1px solid rgba(255,255,255,0.9); }
        .card:hover, .card:active { transform: translateY(-2px); box-shadow: 0 12px 25px -8px rgba(0,0,0,0.1), 0 4px 10px -4px rgba(0,0,0,0.05); border-color: rgba(59, 130, 246, 0.3); }
        
        /* Button Polish */
        button { outline: none; -webkit-tap-highlight-color: transparent; }

        /* --- STAMP OF EXECUTION SYSTEM --- */
        @keyframes stampSlam {
            0% { transform: scale(3) rotate(-20deg); opacity: 0; }
            40% { transform: scale(0.8) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) var(--tilt); opacity: 0.85; }
        }
        .stamp-card {
            background: rgba(248, 250, 252, 0.4) !important;
            border: 2px dashed rgba(203, 213, 225, 0.5) !important;
            box-shadow: none !important;
            opacity: 0.8;
            position: relative;
            overflow: hidden;
            pointer-events: none; /* Inert: Forces you to use the Vault to revive it */
        }
        .stamp-mark {
            position: absolute;
            right: 15px;
            top: 50%;
            margin-top: -16px;
            font-size: 16px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 4px 12px;
            border: 3px solid;
            border-radius: 8px;
            animation: stampSlam 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            backdrop-filter: blur(2px);
        }
        /* Tactical Stamp Variations */
        .stamp-green { color: #16a34a; border-color: #16a34a; --tilt: rotate(-8deg); background: rgba(22, 163, 74, 0.05); }
        .stamp-purple { color: #9333ea; border-color: #9333ea; --tilt: rotate(5deg); background: rgba(147, 51, 234, 0.05); }
        .stamp-blue { color: #2563eb; border-color: #2563eb; --tilt: rotate(-4deg); background: rgba(37, 99, 235, 0.05); }
        .stamp-gold { color: #ca8a04; border-color: #ca8a04; --tilt: rotate(8deg); background: rgba(202, 138, 4, 0.05); }
        
                /* --- THANOS SNAP & DULL VAULT --- */
        .thanos-snap {
            animation: snapDust 1.5s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards !important;
            pointer-events: none;
        }
        @keyframes snapDust {
            0% { filter: blur(0) grayscale(0); opacity: 1; transform: scale(1); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
            20% { filter: blur(2px) sepia(0.5) hue-rotate(-30deg); transform: scale(0.98) translateX(-2px); opacity: 0.8; }
            50% { filter: blur(5px) grayscale(0.8); transform: scale(0.95) translateY(-5px) skewX(2deg); opacity: 0.5; letter-spacing: 2px; border-color: transparent; background: rgba(200,200,200,0.1); }
            100% { filter: blur(15px) grayscale(1); transform: scale(0.9) translateY(-20px) skewX(5deg); opacity: 0; letter-spacing: 10px; }
        }
        .vault-dull-card {
            background: #f1f5f9 !important;
            border: 1px solid #e2e8f0 !important;
            opacity: 0.75;
            filter: grayscale(100%);
            box-shadow: none !important;
        }

        /* --- IRONCLAD DARK MODE OVERRIDES (SMOKED LIQUID GLASS) --- */
        html.dark body { background: #09090b !important; background-image: none !important; color: #e4e4e7 !important; }
        
        /* Core Surfaces */
        html.dark .glass, html.dark .card, html.dark .board-card, html.dark .preview-card { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.4) 0%, rgba(9, 9, 11, 0.7) 100%) !important; 
            backdrop-filter: blur(40px) !important; -webkit-backdrop-filter: blur(40px) !important;
            border-color: rgba(255,255,255,0.08) !important; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.15), inset 0 -1px 1px rgba(0,0,0,0.4) !important; 
        }
        html.dark .glass-nav { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(9, 9, 11, 0.8) 100%) !important; 
            backdrop-filter: blur(40px) !important; -webkit-backdrop-filter: blur(40px) !important;
            border-color: rgba(255,255,255,0.08) !important; 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.9), inset 0 1px 1px rgba(255,255,255,0.15) !important; 
        }
        html.dark .dock-container { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(9, 9, 11, 0.9) 100%) !important; 
            backdrop-filter: blur(40px) !important; -webkit-backdrop-filter: blur(40px) !important;
            border-color: rgba(255,255,255,0.08) !important; 
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.9), inset 0 1px 1px rgba(255,255,255,0.1) !important;
        }
        
        /* Modals & Vaults */
        html.dark .modal, html.dark #file-viewer-modal, html.dark .fv-header, html.dark .fv-footer, html.dark .fv-content { background: #18181b !important; border-color: #27272a !important; }
        html.dark .modal::before { background: #3f3f46 !important; }
        html.dark .vault-content { background: #09090b !important; border-color: #22c55e !important; }
        
        /* Tailwind Background Force-Inversions */
        html.dark .bg-white { background-color: #18181b !important; }
        html.dark .bg-slate-50, html.dark .bg-slate-100, html.dark .bg-slate-200 { background-color: #27272a !important; border-color: #3f3f46 !important; color: #e4e4e7 !important;}
        html.dark .bg-slate-800, html.dark .bg-slate-900 { background-color: #e4e4e7 !important; color: #09090b !important; border-color: #d4d4d8 !important; }
        
        /* Typography Force-Inversions */
        html.dark .text-slate-800, html.dark .text-slate-700, html.dark h1, html.dark h2, html.dark h3 { color: #f4f4f5 !important; }
        html.dark .text-slate-600, html.dark .text-slate-500, html.dark .text-slate-400 { color: #a1a1aa !important; }
        html.dark .border-slate-100, html.dark .border-slate-200, html.dark .border-slate-300 { border-color: #3f3f46 !important; }
        
        /* Inputs & Journals */
        html.dark input, html.dark select, html.dark #j-editor, html.dark .scroller { background-color: #09090b !important; color: #f4f4f5 !important; border-color: #3f3f46 !important; }
        html.dark #j-editor h1, html.dark #j-editor h2, html.dark #j-editor h3, html.dark #j-editor b, html.dark #preview-content h1, html.dark #preview-content h2, html.dark #preview-content h3, html.dark #preview-content b { color: #f4f4f5 !important; }
        
        /* Specifics */
        html.dark .dock-btn { color: #71717a !important; }
        html.dark .dock-btn.active { color: #3b82f6 !important; background: #27272a !important; }
        html.dark .group-header { background: #18181b !important; border-color: #27272a !important; }
        html.dark .board-col { background: #18181b !important; border-color: #27272a !important; }
        html.dark .cal-day-box { background: #18181b !important; border-color: #27272a !important; }
        html.dark .is-today { border-color: #3b82f6 !important; background: #09090b !important; }
        html.dark #header-logo { background-color: #e4e4e7 !important; border-color: #d4d4d8 !important; }
        html.dark #header-logo i { color: #09090b !important; }

        
  </style>
</head>
<body class="text-slate-800">

    <div id="season-overlay"></div>
    <div id="export-canvas-container"></div>
    <div id="success-popup"><div class="success-icon">ðŸ”¥</div><h2 class="text-xl font-black text-slate-800">Great Job!</h2><p class="text-xs text-slate-500 font-bold uppercase mt-1">Keep the streak alive!</p></div>

    <div class="glass-nav" id="top-nav-dock">
        <div class="flex items-center gap-2.5 w-2/3">
            <button id="back-btn" onclick="app.goUp()" class="hidden shrink-0 w-8 h-8 rounded-full bg-slate-100 text-slate-700 flex items-center justify-center tap-scale border border-slate-200 hover:bg-slate-200 transition-colors">
                <i class="fas fa-chevron-left text-xs"></i>
            </button>
            <div class="shrink-0 w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center shadow-md border border-slate-700" id="header-logo">
                <i class="fas fa-layer-group text-white text-xs"></i>
            </div>
            <div class="flex-1 overflow-hidden flex flex-col justify-center">
                <h1 id="page-title" class="font-black text-base leading-tight truncate text-slate-800 tracking-tight uppercase">21</h1>
                <span id="page-subtitle" class="text-[8px] font-bold text-slate-400 tracking-widest uppercase truncate leading-none mt-0.5">ACTIVE DUTY</span>
            </div>
        </div>
        <div class="flex items-center gap-1.5 shrink-0">
            <button onclick="app.openStreakModal()" class="flex items-center gap-1 px-2.5 py-1 bg-orange-50 border border-orange-200 text-orange-600 rounded-full shadow-sm active:scale-95 transition-transform">
                <i class="fas fa-fire text-[10px]"></i> <span id="fire-streak-display" class="font-black text-[10px] font-mono">0</span>
            </button>
            <button onclick="app.openSettings()" class="w-8 h-8 rounded-full bg-slate-50 text-slate-600 flex items-center justify-center shadow-sm border border-slate-200 hover:bg-slate-100 transition-colors active:scale-95">
                <i class="fas fa-sliders-h text-xs"></i>
            </button>
        </div>
        <div id="daily-progress-container" style="position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); width: 40px; height: 3px; border-radius: 4px; background: rgba(0,0,0,0.05); overflow: hidden;"><div id="daily-progress-bar" style="height: 100%; width: 0%; background: #3b82f6; transition: width 0.5s;"></div></div>
    </div>

    <div class="pt-20 px-4 pb-48 relative z-10" id="main-container">
        
        <div id="view-list">
            <div id="reality-check-banner" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 shadow-sm flex items-start gap-3">
                <i class="fas fa-exclamation-triangle mt-1"></i>
                <div>
                    <h4 class="font-black text-xs uppercase tracking-widest">Delusional Workload</h4>
                    <p class="text-[10px] font-bold mt-1 opacity-80" id="reality-check-msg"></p>
                </div>
            </div>

            <div class="glass p-4 mb-6 transition-all duration-300" id="files-widget-container">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2 cursor-pointer" onclick="app.toggleFilesWidget()">
                        <div class="w-6 h-6 rounded-md bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs"><i class="fas fa-folder-open"></i></div>
                        <h3 class="font-bold text-slate-700 text-sm">Important Files</h3>
                        <i class="fas fa-chevron-up text-[10px] text-slate-400 ml-2 transition-transform duration-300" id="files-chevron"></i>
                    </div>
                    <div class="flex gap-2" id="files-actions">
                        <button onclick="app.addGroup('file')" class="text-[10px] font-bold bg-slate-50 text-slate-500 px-2 py-1 rounded border border-slate-100 shadow-sm active:scale-95"><i class="fas fa-folder-plus"></i></button>
                        <input type="file" id="file-upload-input" class="hidden" onchange="app.handleFileUpload(this)">
                        <button onclick="app.prepFileUpload('General')" class="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-100 shadow-sm active:scale-95"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div id="files-body" class="mt-4 border-t border-slate-100 dark:border-zinc-800 pt-3 transition-all duration-300">
                    <div id="files-container" class="space-y-2"></div>
                    <div id="files-empty" class="text-center py-2 text-xs text-slate-400 italic hidden">No files saved.</div>
                </div>
            </div>

            <div id="items-header" class="flex justify-between items-center mb-2 px-1 hidden">
                <h3 class="font-bold text-slate-700 text-sm">Projects & Areas</h3>
                <div class="flex gap-2 items-center">
                    <button onclick="app.openVault()" class="w-8 h-8 rounded-lg bg-slate-800 text-green-400 border border-green-900/50 shadow-sm active:scale-95 flex items-center justify-center transition-transform" title="Access Vault">
                        <i class="fas fa-fingerprint text-sm"></i>
                    </button>
                    <button onclick="app.addGroup('project')" class="text-[10px] font-bold bg-white text-blue-500 px-2 py-1 rounded border border-blue-100 shadow-sm active:scale-95"><i class="fas fa-layer-group mr-1"></i> NEW GROUP</button>
                </div>
            </div>
            <div id="items-list" class="space-y-3"></div>
            
            <div id="empty-state" class="hidden text-center mt-20 opacity-50">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm"><i class="fas fa-layer-group text-3xl text-slate-300"></i></div>
                <p class="text-slate-500 font-medium">No active tasks.</p>
                <p class="text-xs text-slate-400 mt-1">Stop planning. Start executing.</p>
            </div>

        </div>

        <div id="view-calendar" class="hidden">
            <div class="mb-4 flex justify-between items-center bg-slate-200 p-1 rounded-lg">
                <button onclick="app.setCalendarMode('month')" id="btn-mode-month" class="flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-700">CALENDAR</button>
                <button onclick="app.setCalendarMode('board')" id="btn-mode-board" class="flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500">2026 BOARD</button>
            </div>
            <div id="cal-grid-container" class="cal-grid"></div>
            <div id="board-view-container" class="board-container hidden">
                <div class="board-col draggable-item" data-quarter="Q1"><div class="board-header"><span>Q1 <span class="text-xs text-slate-400 font-normal">JAN-MAR</span></span><button onclick="app.quickAddQuarter('Q1')" class="w-6 h-6 rounded bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fas fa-plus text-[10px]"></i></button></div><div class="board-items" id="board-q1" ondrop="app.handleBoardDrop(event, 'Q1')" ondragover="event.preventDefault()"></div></div>
                <div class="board-col draggable-item" data-quarter="Q2"><div class="board-header"><span>Q2 <span class="text-xs text-slate-400 font-normal">APR-JUN</span></span><button onclick="app.quickAddQuarter('Q2')" class="w-6 h-6 rounded bg-orange-50 text-orange-500 flex items-center justify-center"><i class="fas fa-plus text-[10px]"></i></button></div><div class="board-items" id="board-q2" ondrop="app.handleBoardDrop(event, 'Q2')" ondragover="event.preventDefault()"></div></div>
                <div class="board-col draggable-item" data-quarter="Q3"><div class="board-header"><span>Q3 <span class="text-xs text-slate-400 font-normal">JUL-SEP</span></span><button onclick="app.quickAddQuarter('Q3')" class="w-6 h-6 rounded bg-green-50 text-green-500 flex items-center justify-center"><i class="fas fa-plus text-[10px]"></i></button></div><div class="board-items" id="board-q3" ondrop="app.handleBoardDrop(event, 'Q3')" ondragover="event.preventDefault()"></div></div>
                <div class="board-col draggable-item" data-quarter="Q4"><div class="board-header"><span>Q4 <span class="text-xs text-slate-400 font-normal">OCT-DEC</span></span><button onclick="app.quickAddQuarter('Q4')" class="w-6 h-6 rounded bg-purple-50 text-purple-500 flex items-center justify-center"><i class="fas fa-plus text-[10px]"></i></button></div><div class="board-items" id="board-q4" ondrop="app.handleBoardDrop(event, 'Q4')" ondragover="event.preventDefault()"></div></div>
            </div>
        </div>

            <div id="view-journal" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-700 text-sm">Log Entry</h3>
                <input type="date" id="journal-date-picker" class="bg-white border border-slate-200 text-slate-600 text-xs font-bold rounded-lg px-3 py-2 outline-none focus:border-blue-500" onchange="journal.loadDate(this.value)">
            </div>
            
            <div class="glass p-5 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 text-sm" id="journal-date-display">Today</h3>
                    <button id="journal-save-btn" onclick="journal.save()" class="text-[10px] bg-slate-800 text-white px-3 py-1.5 rounded-lg font-bold shadow-lg shadow-slate-300 transition-all active:scale-95">SAVE</button>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-2">
                    <div>
                        <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Study (Hrs)</label>
                        <input type="number" id="j-study" min="0" step="0.5" class="w-full p-2 bg-slate-50 rounded-lg text-xs font-mono border border-slate-100">
                    </div>
                    <div>
                        <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Height (cm)</label>
                        <input type="number" id="j-height" step="0.1" placeholder="0.0" class="w-full p-2 bg-slate-50 rounded-lg text-xs font-mono border border-slate-100">
                    </div>
                    <div>
                        <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Exercise?</label>
                        <select id="j-exercise" class="w-full p-2 bg-slate-50 rounded-lg text-xs font-bold border border-slate-100">
                            <option value="No">No</option>
                            <option value="Yes">Yes ðŸ”¥</option>
                        </select>
                    </div>
                </div>

                <div id="custom-markers-container" class="grid grid-cols-3 gap-2 mb-4"></div>

                <div class="flex gap-2 mb-4">
                    <button onclick="journal.viewHeightTrend()" class="flex-1 py-2 bg-emerald-50 text-emerald-600 text-[10px] font-bold rounded-lg border border-emerald-100 active:scale-95 transition-transform">
                        <i class="fas fa-chart-line mr-1"></i> GROWTH CHART
                    </button>
                    <button onclick="journal.openMarkerModal()" class="flex-1 py-2 bg-purple-50 text-purple-600 text-[10px] font-bold rounded-lg border border-purple-100 active:scale-95 transition-transform">
                        <i class="fas fa-plus mr-1"></i> NEW MARKER
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-3 border-t border-slate-100 pt-3">
                    <div class="text-center"><label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Wake Up</label><input type="time" id="j-wakeup" class="w-full p-2 bg-slate-50 rounded-lg text-xs text-center font-mono"></div>
                    <div class="text-center"><label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Bath</label><input type="time" id="j-bath" class="w-full p-2 bg-slate-50 rounded-lg text-xs text-center font-mono"></div>
                    <div class="text-center"><label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Breakfast</label><input type="time" id="j-bf" class="w-full p-2 bg-slate-50 rounded-lg text-xs text-center font-mono"></div>
                    <div class="text-center"><label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Lunch</label><input type="time" id="j-lunch" class="w-full p-2 bg-slate-50 rounded-lg text-xs text-center font-mono"></div>
                    <div class="text-center"><label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Dinner</label><input type="time" id="j-dinner" class="w-full p-2 bg-slate-50 rounded-lg text-xs text-center font-mono"></div>
                    <div class="text-center"><label class="block text-[9px] font-bold text-slate-400 uppercase mb-1">Sleep</label><input type="time" id="j-sleep" class="w-full p-2 bg-slate-50 rounded-lg text-xs text-center font-mono"></div>
                </div>
            </div>
            
            <div class="glass p-5 mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-slate-700 text-sm">Reflection</h3>
                    <button onclick="document.getElementById('img-input').click()" class="text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100"><i class="fas fa-camera mr-1"></i> Photo</button>
                    <input type="file" id="img-input" accept="image/*" class="hidden" onchange="journal.handleImage(this)">
                </div>
                
                <div class="flex flex-wrap gap-1 mb-2 pb-2 border-b border-slate-100 overflow-x-auto">
                    <button onclick="journal.format('formatBlock','h1')" class="h-7 px-2 rounded bg-slate-100 text-[10px] font-black text-slate-600 hover:bg-slate-200">TITLE</button>
                    <button onclick="journal.format('formatBlock','h2')" class="h-7 px-2 rounded bg-slate-100 text-[10px] font-bold text-slate-600 hover:bg-slate-200">HEAD</button>
                    <button onclick="journal.format('bold')" class="w-7 h-7 rounded bg-white border border-slate-200 text-xs font-bold hover:bg-slate-50"><i class="fas fa-bold"></i></button>
                    <button onclick="journal.format('hiliteColor','#fef08a')" class="w-6 h-6 rounded-full bg-yellow-200 border border-yellow-300"></button>
                    <button onclick="journal.format('hiliteColor','#bbf7d0')" class="w-6 h-6 rounded-full bg-green-200 border border-green-300"></button>
                </div>

                <div id="j-editor" class="w-full bg-slate-50 rounded-xl p-3 text-slate-700 border border-transparent focus:bg-white focus:border-slate-200 transition-colors" contenteditable="true"></div>
                <div id="j-img-preview" class="flex gap-2 mt-3 overflow-x-auto pb-1 pt-1"></div>
            </div>
            
            <h3 class="font-bold text-slate-400 text-xs uppercase tracking-widest mb-3 pl-2">History</h3>
            <div class="space-y-6" id="journal-history"></div>
        </div>
        


        <div id="view-stats" class="hidden bento-grid">
                  <div id="health-card" onclick="app.openHealthAnalysis()" class="cursor-pointer tap-scale rounded-3xl p-6 text-white shadow-xl bento-wide transition-all duration-500 relative overflow-hidden bg-gradient-to-br from-slate-400 to-slate-500 shadow-lg">
                <div class="relative z-10 flex justify-between items-start">
                    <div><p class="text-white/80 text-[10px] font-bold uppercase tracking-widest">Productivity (Tap for Intel)</p><h2 class="text-4xl font-extrabold mt-2 tracking-tight" id="stat-health-text">--%</h2></div>
                    <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center"><i class="fas fa-heartbeat text-xl"></i></div>
                </div>
                <p class="relative z-10 text-white/90 text-xs mt-4 font-medium" id="stat-health-sub">Analyzing...</p>
            </div>
            
            <div class="bento-wide mt-2">
                 <div class="flex justify-between items-center mb-3 px-1">
                    <h3 class="font-bold text-slate-700 text-sm">Programs & Rewards</h3>
                    <button onclick="app.openProgramModal()" class="text-[10px] font-bold bg-purple-50 text-purple-600 px-3 py-1.5 rounded-lg border border-purple-100 shadow-sm active:scale-95 transition-transform"><i class="fas fa-plus mr-1"></i> NEW PROGRAM</button>
                </div>
                <div id="programs-list" class="flex gap-3 overflow-x-auto pb-4 snap-x"></div>
            </div>

            <div class="glass p-4 bg-white flex flex-col justify-between tap-scale">
                <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-2"><i class="fas fa-flag-checkered"></i></div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Finish Date</p><h3 class="text-md font-bold text-slate-800 font-mono truncate" id="stat-prediction">--</h3></div>
            </div>
            <div onclick="app.openLoadAnalysis()" class="cursor-pointer tap-scale glass p-4 bg-white flex flex-col justify-between border border-blue-100 hover:border-blue-300 transition-colors">
                <div class="flex justify-between items-start mb-2">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-bolt"></i></div>
                    <i class="fas fa-expand-alt text-[10px] text-slate-300"></i>
                </div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Active Load</p><h3 class="text-2xl font-black text-slate-800 font-mono mt-1" id="stat-active-count">0</h3></div>
            </div>
            
            <button onclick="app.downloadReport()" class="glass p-4 bento-wide flex items-center justify-between bg-slate-800 text-white active:scale-95 transition-transform">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center text-lg"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="text-left"><h3 class="font-bold text-sm">Download Report</h3><p class="text-[10px] text-slate-300">Analysis & Pending Work</p></div>
                </div>
                <i class="fas fa-chevron-right opacity-50"></i>
            </button>
            
                        <div class="glass p-5 bento-wide bg-slate-900 text-slate-300 border border-slate-700 shadow-inner">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-red-500 text-sm"><i class="fas fa-skull text-red-600 mr-2"></i>The Graveyard</h3>
                    <span class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">Excuses Logged</span>
                </div>
                <div id="graveyard-list" class="space-y-2 max-h-48 overflow-y-auto pr-1 scroller">
                    </div>
            </div>


            <div class="glass p-5 bento-wide bg-white">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <h3 class="font-bold text-slate-800 text-sm tracking-tight">Workload Forecast</h3>
                        <p class="text-[10px] text-slate-400 font-bold mt-0.5 uppercase">Daily Active Tasks</p>
                    </div>
                    <div class="flex gap-1"><span class="w-2 h-2 rounded-full bg-blue-500 shadow-sm"></span><span class="w-2 h-2 rounded-full bg-orange-400 shadow-sm"></span><span class="w-2 h-2 rounded-full bg-red-500 shadow-sm"></span></div>
                </div>
                <div class="scroller"><div id="forecast-wrapper" style="height: 180px; position: relative;"><canvas id="chart-forecast"></canvas></div></div>
            </div>
             <div class="glass p-5 bento-wide bg-white">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <h3 class="font-bold text-slate-800 text-sm tracking-tight">Velocity Burn-Up</h3>
                        <p class="text-[10px] text-slate-400 font-bold mt-0.5 uppercase">Completion Trajectory</p>
                    </div>
                </div>
                <div style="height: 190px; position: relative;"><canvas id="chart-velocity"></canvas></div>
            </div>
        </div>
        
        <div class="text-center mt-10 mb-2">
            <p class="text-[10px] font-black font-mono tracking-widest text-rose-800">MADE BY OG_ADITYAX</p>
        </div>
        <div class="h-32"></div> 
    </div>

    <div id="preview-overlay" class="preview-overlay" onclick="app.closePreview(event)">
        <div class="preview-card" onclick="event.stopPropagation()">
            <div id="preview-header" class="p-6 bg-gradient-to-r from-blue-500 to-indigo-600 text-white relative">
                <h2 id="prev-date-num" class="text-3xl font-bold truncate pr-6">--</h2>
                <p id="prev-date-day" class="text-xs font-medium opacity-90 uppercase tracking-widest mt-1">--</p>
                <button onclick="app.forceClosePreview()" class="absolute top-4 right-4 w-8 h-8 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 max-h-[60vh] overflow-y-auto" id="preview-list"></div>
        </div>
    </div>

    <div class="modal-overlay" id="streak-overlay" onclick="if(event.target===this) document.getElementById('streak-overlay').classList.remove('open')">
        <div class="modal">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">Streak Status</h3>
                <button onclick="document.getElementById('streak-overlay').classList.remove('open')" class="w-8 h-8 bg-slate-100 rounded-full text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="streak-row border-l-4 border-orange-500">
                <div>
                    <h4 class="font-bold text-slate-700 text-sm">Determination ðŸ”¥</h4>
                    <p class="text-[10px] text-slate-400">Complete at least 1 task daily.</p>
                </div>
                <div class="text-2xl font-black text-orange-500" id="streak-fire-count">0</div>
            </div>
            <div class="streak-row border-l-4 border-purple-600">
                <div>
                    <h4 class="font-bold text-slate-700 text-sm">Aaj to phod dala ðŸ¥µ</h4>
                    <p class="text-[10px] text-slate-400">Complete >1 task daily.</p>
                </div>
                <div class="text-2xl font-black text-purple-600" id="streak-phod-count">0</div>
            </div>
            
            <div class="mt-4 border-t border-slate-100 pt-4">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-slate-700 text-sm">Focus Projects</h4>
                    <button onclick="app.openAddProjectModal()" class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded">ADD PROJECT</button>
                </div>
                <div id="streak-project-list" class="space-y-2 max-h-32 overflow-y-auto"></div>
            </div>

            <div class="mt-4">
                <h4 class="font-bold text-slate-400 text-xs uppercase tracking-widest mb-2">History</h4>
                <div id="streak-history-list" class="space-y-2 text-xs text-slate-600 bg-slate-50 p-4 rounded-xl max-h-40 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="add-project-modal" onclick="if(event.target===this) document.getElementById('add-project-modal').classList.remove('open')">
        <div class="modal">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Select Project to Track</h3>
            <div id="streak-project-selection-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
        </div>
    </div>

    <div class="modal-overlay" id="settings-overlay" onclick="if(event.target===this) document.getElementById('settings-overlay').classList.remove('open')">
        <div class="modal">
            <h3 class="text-xl font-bold text-slate-800 mb-6">System Settings</h3>
            
            <button id="install-pwa-btn" onclick="app.installPWA()" class="w-full py-4 mb-3 bg-indigo-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-transform active:scale-95 shadow-lg shadow-indigo-600/30">
                <i class="fas fa-download"></i> Install Native App
            </button>

            <button onclick="app.toggleTheme()" id="theme-toggle-btn" class="w-full py-4 mb-3 bg-slate-800 text-slate-100 font-bold rounded-xl flex items-center justify-center gap-2 transition-colors">
                <i class="fas fa-moon"></i> Engage Dark Mode
            </button>
            
            <div class="border-t border-slate-200 my-4"></div>
            
            <button onclick="app.exportData()" class="w-full py-4 mb-3 bg-blue-50 text-blue-600 font-bold rounded-xl flex items-center justify-center gap-2"><i class="fas fa-file-export"></i> Backup Data (JSON)</button>
            <label class="w-full py-4 mb-6 bg-slate-50 text-slate-600 font-bold rounded-xl flex items-center justify-center gap-2 cursor-pointer"><i class="fas fa-file-import"></i> Restore Data <input type="file" class="hidden" accept=".json" onchange="app.importData(this)"></label>
            <button onclick="if(confirm('Delete EVERYTHING?')){localStorage.clear();location.reload()}" class="w-full py-4 bg-red-50 text-red-500 font-bold rounded-xl"><i class="fas fa-trash-alt mr-2"></i> Factory Reset</button>
        </div>
    </div>

    <div class="modal-overlay" id="program-modal-overlay" onclick="if(event.target===this) document.getElementById('program-modal-overlay').classList.remove('open')">
        <div class="modal">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">New Program</h3>
                <button onclick="document.getElementById('program-modal-overlay').classList.remove('open')" class="w-8 h-8 bg-slate-100 rounded-full text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <form onsubmit="app.handleProgramSave(event)">
                <div class="mb-4"><label class="text-[10px] font-bold text-slate-400 uppercase">Program Name</label><input type="text" id="prog-name" required placeholder="e.g., Exam Prep" class="w-full p-3 bg-slate-100 rounded-xl mt-1 font-semibold outline-none focus:ring-2 focus:ring-purple-500"></div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                     <div><label class="text-[10px] font-bold text-slate-400 uppercase">Reward Name</label><input type="text" id="prog-reward" required placeholder="e.g., Pizza" class="w-full p-3 bg-slate-100 rounded-xl mt-1 text-xs font-bold outline-none"></div>
                     <div><label class="text-[10px] font-bold text-slate-400 uppercase">Milestone (%)</label><input type="number" id="prog-milestone" required value="100" min="1" max="100" class="w-full p-3 bg-slate-100 rounded-xl mt-1 text-xs font-bold outline-none"></div>
                </div>
                <div class="mb-5">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Add Tasks/Projects</label>
                    <div id="prog-task-list" class="max-h-40 overflow-y-auto bg-slate-50 rounded-xl p-2 border border-slate-100 space-y-2"></div>
                </div>
                <button type="submit" class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl shadow-lg shadow-purple-500/30">Create Program</button>
            </form>
        </div>
    </div>

    <div id="file-viewer-modal" class="hidden-viewer normal">
        <div class="fv-header" onclick="app.restoreFileViewer()">
            <div class="flex items-center gap-2 overflow-hidden">
                <i class="fas fa-file-alt text-blue-500"></i>
                <span id="fv-title" class="font-bold text-xs text-slate-700 truncate">Document</span>
            </div>
            <div class="fv-controls flex items-center gap-2">
                <button onclick="event.stopPropagation(); app.toggleFileMinimize()" class="w-6 h-6 rounded bg-slate-100 hover:bg-slate-200 text-slate-500 flex items-center justify-center btn-min"><i class="fas fa-minus text-[10px]"></i></button>
                <button onclick="event.stopPropagation(); app.toggleFileMaximize()" class="w-6 h-6 rounded bg-slate-100 hover:bg-slate-200 text-slate-500 flex items-center justify-center btn-min"><i class="far fa-square text-[10px]"></i></button>
                <button onclick="event.stopPropagation(); app.closeFileViewer()" class="w-6 h-6 rounded bg-red-50 hover:bg-red-100 text-red-500 flex items-center justify-center"><i class="fas fa-times text-[10px]"></i></button>
            </div>
        </div>
        <div class="fv-content" id="fv-body"></div>
        <div class="fv-footer">
            <a href="#" target="_blank" id="fv-external-link" class="text-blue-600 font-bold text-xs">OPEN</a>
        </div>
    </div>

    <button class="fab" id="main-fab" onclick="app.openModal('create')"><i class="fas fa-plus"></i></button>

    <div class="dock-container">
        <button onclick="app.switchTab('list')" class="dock-btn active" id="btn-list"><i class="fas fa-stream"></i><span class="dock-lbl">TRACK</span></button>
        <button onclick="app.switchTab('calendar')" class="dock-btn" id="btn-calendar"><i class="far fa-calendar-alt"></i><span class="dock-lbl">PLAN</span></button>
        <button onclick="app.switchTab('journal')" class="dock-btn" id="btn-journal"><i class="fas fa-feather-alt"></i><span class="dock-lbl">LOG</span></button>
        <button onclick="app.switchTab('stats')" class="dock-btn" id="btn-stats"><i class="fas fa-chart-pie"></i><span class="dock-lbl">STATS</span></button>
    </div>

    <div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this) app.closeModal()">
        <div class="modal">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800" id="modal-title">New Item</h3>
                <button onclick="app.closeModal()" class="w-8 h-8 bg-slate-100 rounded-full text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <form onsubmit="app.handleSave(event)">
                <input type="hidden" id="inp-id">
                <div class="flex bg-slate-100 p-1 rounded-xl mb-5">
                    <button type="button" onclick="app.setMode('task')" id="mode-task" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-white shadow text-blue-600">TASK</button>
                    <button type="button" onclick="app.setMode('event')" id="mode-event" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all text-slate-400">EVENT</button>
                </div>
                <input type="hidden" id="inp-type" value="task">
                
                <div class="mb-5"><label class="text-[10px] font-bold text-slate-400 uppercase">Title</label><input type="text" id="inp-title" required class="w-full p-3 bg-slate-100 rounded-xl mt-1 font-semibold outline-none focus:ring-2 focus:ring-blue-500"></div>
                
                <div id="field-group" class="mb-5 hidden">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Group Category</label>
                    <select id="inp-group" class="w-full p-3 bg-slate-100 rounded-xl mt-1 font-semibold outline-none"></select>
                </div>

                <div id="field-priority" class="mb-5"><label class="text-[10px] font-bold text-slate-400 uppercase">Priority</label>
                    <div class="grid grid-cols-3 gap-3 mt-1">
                        <label class="cursor-pointer"><input type="radio" name="priority" value="High" class="peer hidden"><div class="text-center py-2 rounded-lg bg-slate-50 text-red-500 font-bold text-xs peer-checked:bg-red-500 peer-checked:text-white transition-all">HIGH</div></label>
                        <label class="cursor-pointer"><input type="radio" name="priority" value="Medium" class="peer hidden" checked><div class="text-center py-2 rounded-lg bg-slate-50 text-amber-500 font-bold text-xs peer-checked:bg-amber-400 peer-checked:text-white transition-all">MED</div></label>
                        <label class="cursor-pointer"><input type="radio" name="priority" value="Low" class="peer hidden"><div class="text-center py-2 rounded-lg bg-slate-50 text-blue-500 font-bold text-xs peer-checked:bg-blue-500 peer-checked:text-white transition-all">LOW</div></label>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div id="field-start"><label class="text-[10px] font-bold text-slate-400 uppercase">Start</label><input type="date" id="inp-start" required class="w-full p-3 bg-slate-100 rounded-xl mt-1 text-xs font-bold outline-none"></div>
                    <div id="field-end"><label class="text-[10px] font-bold text-slate-400 uppercase" id="label-end">Due</label><input type="date" id="inp-end" required class="w-full p-3 bg-slate-100 rounded-xl mt-1 text-xs font-bold outline-none"></div>
                </div>
                <button type="submit" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30">Save</button>
            </form>
        </div>
    </div>
   
     <div class="omnitrix-overlay" id="vault-overlay" onclick="if(event.target===this) app.closeVault()">
        <div class="omnitrix-core"></div>
        <div class="vault-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
                <div>
                    <h2 class="text-2xl font-black text-green-600 tracking-tight"><i class="fas fa-archive mr-2"></i>THE VAULT</h2>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Completed Objectives Only</p>
                </div>
                <button onclick="app.closeVault()" class="w-10 h-10 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 hover:text-red-500 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex items-center gap-2 mb-4">
                <button id="vault-back-btn" onclick="app.vaultGoUp()" class="hidden w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center hover:bg-green-100 transition-colors"><i class="fas fa-chevron-left"></i></button>
                <h3 id="vault-title" class="font-bold text-slate-700 text-sm">Root Categories</h3>
            </div>
            <div id="vault-list" class="space-y-3 pb-10"></div>
        </div>
    </div>
    
    <script>
    
           // --- 0. DOPAMINE ENGINE (19+ EFFECTS) ---
    const dopamine = {
        defaults: { origin: { y: 0.7 } },
        
        trigger: () => {
            const effects = [
                dopamine.basic, dopamine.randomDir, dopamine.fireworks, dopamine.schoolPride,
                dopamine.stars, dopamine.hearts, dopamine.fire, dopamine.snow,
                dopamine.realRain, dopamine.money, dopamine.blastLeft, dopamine.blastRight,
                dopamine.vortex, dopamine.slowFall, dopamine.centerExplosion,
                () => dopamine.textPop("CRUSHED IT!", "linear-gradient(to right, #facc15, #ca8a04)"),
                () => dopamine.textPop("LEGENDARY!", "linear-gradient(to right, #c084fc, #9333ea)"),
                () => dopamine.textPop("UNSTOPPABLE!", "linear-gradient(to right, #f87171, #dc2626)"),
                () => dopamine.textPop("GLORIOUS!", "linear-gradient(to right, #4ade80, #16a34a)"),
                dopamine.goldenFlash
            ];
            // Pick a random effect
            const effect = effects[Math.floor(Math.random() * effects.length)];
            effect();
            
            // Always show the small UI popup as well
            const popup = document.getElementById('success-popup');
            if(popup) {
                popup.classList.add('active');
                setTimeout(() => popup.classList.remove('active'), 2000);
            }
        },

        // 1. Basic
        basic: () => confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }),

        // 2. Random Direction
        randomDir: () => confetti({ angle: 60 + Math.random() * 60, spread: 55, particleCount: 60, origin: { x: Math.random(), y: 0.6 } }),

        // 3. Fireworks
        fireworks: () => {
            let duration = 15 * 100;
            let animationEnd = Date.now() + duration;
            let interval = setInterval(function() {
                let timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                let particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 }, { particleCount, origin: { x: Math.random(), y: Math.random() - 0.2 } }));
            }, 250);
        },

        // 4. School Pride
        schoolPride: () => {
            let end = Date.now() + (1 * 1000);
            (function frame() {
                confetti({ particleCount: 2, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#bb0000', '#ffffff'] });
                confetti({ particleCount: 2, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#bb0000', '#ffffff'] });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        },

        // 5. Stars
        stars: () => {
            const defaults = { spread: 360, ticks: 50, gravity: 0, decay: 0.94, startVelocity: 30, shapes: ['star'], colors: ['#FFE400', '#FFBD00', '#E89400', '#FFCA6C', '#FDFFB8'] };
            confetti({ ...defaults, particleCount: 40, scalar: 1.2, shapes: ['star'] });
            confetti({ ...defaults, particleCount: 10, scalar: 0.75, shapes: ['circle'] });
        },

        // 6. Hearts
        hearts: () => {
            confetti({ particleCount: 50, spread: 100, origin: { y: 0.6 }, shapes: ['heart'], colors: ['#FFC0CB', '#FF69B4', '#FF1493', '#C71585'] }); // Pink hearts
        },

        // 7. Fire Emojis
        fire: () => {
             const scalar = 2;
             const fire = confetti.shapeFromText({ text: 'ðŸ”¥', scalar });
             confetti({ particleCount: 30, spread: 100, origin: { y: 0.7 }, shapes: [fire], scalar });
        },

        // 8. Snow
        snow: () => {
            let duration = 3 * 1000;
            let animationEnd = Date.now() + duration;
            let skew = 1;
            (function frame() {
                let timeLeft = animationEnd - Date.now();
                let ticks = Math.max(200, 500 * (timeLeft / duration));
                skew = Math.max(0.8, skew - 0.001);
                confetti({ particleCount: 1, startVelocity: 0, ticks: ticks, origin: { x: Math.random(), y: (Math.random() * skew) - 0.2 }, colors: ['#ffffff'], shapes: ['circle'], gravity: 0.6, scalar: 0.5, drift: 0 });
                if (timeLeft > 0) requestAnimationFrame(frame);
            }());
        },

        // 9. Real Rain
        realRain: () => {
             confetti({ particleCount: 100, spread: 180, origin: { y: -0.1 }, startVelocity: 40, gravity: 1.5, drift: 0, ticks: 400, colors: ['#2563eb', '#60a5fa'], shapes: ['square'], scalar: 0.5 });
        },

        // 10. Money
        money: () => {
             const scalar = 2;
             const cash = confetti.shapeFromText({ text: 'ðŸ’¸', scalar });
             confetti({ particleCount: 30, spread: 90, origin: { y: 0.6 }, shapes: [cash], scalar });
        },

        // 11. Blast Left
        blastLeft: () => confetti({ particleCount: 100, angle: 60, spread: 70, origin: { x: 0, y: 0.6 } }),

        // 12. Blast Right
        blastRight: () => confetti({ particleCount: 100, angle: 120, spread: 70, origin: { x: 1, y: 0.6 } }),

        // 13. Vortex
        vortex: () => {
            let count = 200;
            let defaults = { origin: { y: 0.7 } };
            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, { particleCount: Math.floor(count * particleRatio) }));
            }
            fire(0.25, { spread: 26, startVelocity: 55 });
            fire(0.2, { spread: 60 });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45 });
        },

        // 14. Slow Fall
        slowFall: () => confetti({ particleCount: 100, spread: 360, startVelocity: 20, gravity: 0.4, ticks: 300, origin: { y: 0.1 }, colors: ['#FFD700', '#C0C0C0'] }),

        // 15. Center Explosion
        centerExplosion: () => confetti({ particleCount: 150, spread: 180, origin: { y: 0.5 }, startVelocity: 45 }),

        // 16. Text Pop Function
        textPop: (text, gradient) => {
            const el = document.createElement('div');
            el.className = 'dopamine-text';
            el.innerText = text;
            if(gradient) { el.style.backgroundImage = gradient; el.style.webkitBackgroundClip = 'text'; el.style.webkitTextFillColor = 'transparent'; }
            document.body.appendChild(el);
            confetti({ particleCount: 50, spread: 90, origin: { y: 0.6 } }); // Add generic confetti with text
            setTimeout(() => el.remove(), 2000);
        },

                    // 17. Golden Flash
        goldenFlash: () => {
             const el = document.createElement('div');
             el.className = 'flash-overlay';
             el.style.background = 'radial-gradient(circle, rgba(253,224,71,0.4) 0%, rgba(255,255,255,0) 70%)';
             document.body.appendChild(el);
             setTimeout(() => el.remove(), 600);
             confetti({ particleCount: 80, spread: 100, origin: { y: 0.6 }, colors: ['#facc15'] });
        },

        // 18. Punish (Brutal Honesty)
        punish: () => {
             const el = document.createElement('div');
             el.className = 'flash-overlay';
             el.style.background = 'radial-gradient(circle, rgba(239,68,68,0.5) 0%, rgba(255,255,255,0) 70%)';
             document.body.appendChild(el);
             setTimeout(() => el.remove(), 600);
             dopamine.textPop("EXCUSE LOGGED", "linear-gradient(to right, #ef4444, #991b1b)");
        }
    };

 // --- 1. JOURNAL ENGINE (UPDATED WITH HEIGHT) ---
   const journal = {
    data: {}, 
    customMarkers: [],
    
    cats: [
        {id:'wakeup', icon:'â˜€ï¸', color:'j-bg-yellow'}, {id:'bath', icon:'ðŸ›', color:'j-bg-blue'},
        {id:'bf', icon:'ðŸ³', color:'j-bg-orange'}, {id:'lunch', icon:'ðŸ±', color:'j-bg-green'},
        {id:'dinner', icon:'ðŸ½ï¸', color:'j-bg-red'}, {id:'sleep', icon:'ðŸŒ™', color:'j-bg-purple'}
    ],
    currentDate: new Date().toLocaleDateString('en-CA', {timeZone: 'Asia/Kolkata'}),
    tempImages: [],

    init: async () => {
        // One-time migration from LocalStorage to IndexedDB
        if (localStorage.getItem('zenith_minimal_journal')) {
            await idb.set('zenith_journal', JSON.parse(localStorage.getItem('zenith_minimal_journal')));
            localStorage.removeItem('zenith_minimal_journal');
        }
        if (localStorage.getItem('zenith_custom_markers')) {
            await idb.set('zenith_custom_markers', JSON.parse(localStorage.getItem('zenith_custom_markers')));
            localStorage.removeItem('zenith_custom_markers');
        }

        // Boot from hard drive
        journal.data = await idb.get('zenith_journal') || {};
        journal.customMarkers = await idb.get('zenith_custom_markers') || [];

        const today = app.getIST();
        const picker = document.getElementById('journal-date-picker');
        if(picker) { picker.value = today; picker.max = today; }
        journal.renderCustomInputs(); 
        journal.loadDate(today);
        journal.renderHistory();
    },
    
    // --- NEW: Custom Marker Logic ---
    openMarkerModal: () => {
        document.getElementById('marker-modal').classList.add('open');
        const list = document.getElementById('existing-markers-list');
        list.innerHTML = '';
        if(journal.customMarkers.length === 0) list.innerHTML = '<span class="text-xs text-slate-300 italic">None created yet.</span>';
        journal.customMarkers.forEach((m, idx) => {
            list.innerHTML += `<button type="button" onclick="journal.deleteMarker(${idx})" class="px-2 py-1 bg-white border border-slate-200 rounded text-xs font-bold text-slate-600 shadow-sm hover:bg-red-50 hover:text-red-500 transition-colors">${m.icon} ${m.label} <i class="fas fa-times ml-1 opacity-50"></i></button>`;
        });
    },

    saveNewMarker: (e) => {
        e.preventDefault();
        const label = document.getElementById('marker-name').value;
        const icon = document.getElementById('marker-icon').value;
        const type = document.getElementById('marker-type').value;
        const id = 'custom_' + Date.now();
        
        journal.customMarkers.push({ id, label, icon, type });
        idb.set('zenith_custom_markers', journal.customMarkers); // Fire-and-forget save
        
        // Reset form
        document.getElementById('marker-name').value = '';
        document.getElementById('marker-icon').value = '';
        document.getElementById('marker-modal').classList.remove('open');
        
        journal.renderCustomInputs();
        journal.loadDate(journal.currentDate); // Reload to ensure data consistency
    },

    deleteMarker: (idx) => {
        if(confirm('Delete this marker? Past data will be hidden but not deleted.')) {
            journal.customMarkers.splice(idx, 1);
            idb.set('zenith_custom_markers', journal.customMarkers); // Fire-and-forget save
            journal.openMarkerModal(); // Refresh list
            journal.renderCustomInputs(); // Refresh UI
        }
    },

    renderCustomInputs: () => {
        const container = document.getElementById('custom-markers-container');
        if(!container) return;
        container.innerHTML = '';
        
        journal.customMarkers.forEach(m => {
            let inputHtml = '';
            if(m.type === 'yesno') {
                inputHtml = `<select id="${m.id}" class="w-full p-2 bg-slate-50 rounded-lg text-xs font-bold border border-slate-100"><option value="">-</option><option value="No">No</option><option value="Yes">Yes</option></select>`;
            } else if(m.type === 'number') {
                inputHtml = `<input type="number" id="${m.id}" step="any" class="w-full p-2 bg-slate-50 rounded-lg text-xs font-mono border border-slate-100">`;
            } else if (m.type === 'time') {
                inputHtml = `<input type="time" id="${m.id}" class="w-full p-2 bg-slate-50 rounded-lg text-xs font-mono border border-slate-100">`;
            } else {
                inputHtml = `<input type="text" id="${m.id}" class="w-full p-2 bg-slate-50 rounded-lg text-xs border border-slate-100">`;
            }
            
            container.innerHTML += `
                <div>
                    <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1 truncate">${m.icon} ${m.label}</label>
                    ${inputHtml}
                </div>
            `;
        });
    },

    format: (cmd, val) => {
        document.execCommand(cmd, false, val);
        document.getElementById('j-editor').focus();
    },

    loadDate: (dateStr) => {
        journal.currentDate = dateStr;
        const today = app.getIST();
        const btn = document.getElementById('journal-save-btn');
        const display = document.getElementById('journal-date-display');
        if(dateStr > today) { display.innerText="Future"; btn.disabled=true; btn.classList.add('opacity-50'); return; }
        else { btn.disabled=false; btn.classList.remove('opacity-50'); display.innerText=dateStr===today?"Today":dateStr; }
        
        const entry = journal.data[dateStr];
        
        // Clear standard fields
        journal.cats.forEach(c => { const el = document.getElementById('j-'+c.id); if(el) el.value = ''; });
        document.getElementById('j-study').value = '';
        document.getElementById('j-height').value = ''; 
        document.getElementById('j-exercise').value = 'No';
        
        // Clear custom fields
        journal.customMarkers.forEach(m => {
            const el = document.getElementById(m.id);
            if(el) el.value = (m.type === 'yesno') ? '' : '';
        });

        const editor = document.getElementById('j-editor');
        editor.innerHTML = '';
        journal.tempImages = []; document.getElementById('j-img-preview').innerHTML = '';
        
        if(entry) {
            journal.cats.forEach(c => { if(entry[c.id]) document.getElementById('j-'+c.id).value = entry[c.id]; });
            if(entry.study) document.getElementById('j-study').value = entry.study;
            if(entry.height) document.getElementById('j-height').value = entry.height;
            if(entry.exercise) document.getElementById('j-exercise').value = entry.exercise;
            
            // Load custom fields
            if(entry.custom) {
                journal.customMarkers.forEach(m => {
                    if(entry.custom[m.id]) {
                        const el = document.getElementById(m.id);
                        if(el) el.value = entry.custom[m.id];
                    }
                });
            }

            if(entry.htmlContent) editor.innerHTML = entry.htmlContent;
            if(entry.images) { journal.tempImages = [...entry.images]; journal.renderImgPreview(); }
        }
    },
    
    save: () => {
        const date = journal.currentDate;
        if(date > app.getIST()) return;
        const entry = journal.data[date] || { date: date };
        
        // Save standard fields
        journal.cats.forEach(c => { const val = document.getElementById('j-'+c.id).value; if(val) entry[c.id] = val; });
        entry.study = document.getElementById('j-study').value;
        entry.height = document.getElementById('j-height').value;
        entry.exercise = document.getElementById('j-exercise').value;
        
        // NEW: Save custom fields
        entry.custom = entry.custom || {};
        journal.customMarkers.forEach(m => {
            const el = document.getElementById(m.id);
            if(el && el.value) entry.custom[m.id] = el.value;
        });

        entry.htmlContent = document.getElementById('j-editor').innerHTML;
        entry.images = journal.tempImages;
        journal.data[date] = entry;
        
        // Massive image array saved safely to hard drive
        idb.set('zenith_journal', journal.data);
        
        journal.renderHistory(); 
        dopamine.trigger();
    },

    viewHeightTrend: () => {
        const entries = Object.values(journal.data)
            .filter(e => e.height && !isNaN(e.height))
            .sort((a,b) => new Date(a.date) - new Date(b.date));
        
        if(entries.length < 2) { alert("Log your height on at least 2 different days to see a chart!"); return; }

        const dates = entries.map(e => e.date.slice(5)); 
        const heights = entries.map(e => e.height);

        document.getElementById('prev-date-num').innerText = "Height";
        document.getElementById('prev-date-day').innerText = "Growth History";
        
        const list = document.getElementById('preview-list');
        list.innerHTML = `<div style="height:250px"><canvas id="height-chart"></canvas></div>`;
        document.getElementById('preview-overlay').classList.add('active');

        setTimeout(() => {
            new Chart(document.getElementById('height-chart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Height (cm)',
                        data: heights,
                        borderColor: '#10b981', 
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#10b981'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} } }
            });
        }, 100);
    },

    handleImage: (input) => {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                    const scale = 300 / img.width; cvs.width = 300; cvs.height = img.height * scale;
                    ctx.drawImage(img,0,0,cvs.width,cvs.height);
                    const url = cvs.toDataURL('image/jpeg', 0.6);
                    journal.tempImages.push(url); journal.renderImgPreview();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    },
    removeImage: (idx) => { journal.tempImages.splice(idx, 1); journal.renderImgPreview(); },
    renderImgPreview: () => {
        const container = document.getElementById('j-img-preview'); container.innerHTML = '';
        journal.tempImages.forEach((src, idx) => {
            container.innerHTML += `<div class="note-img-wrapper"><img src="${src}" class="note-img"><div onclick="journal.removeImage(${idx})" class="note-remove-btn"><i class="fas fa-times"></i></div></div>`;
        });
    },
    openLogPreview: (dateStr) => {
        const entry = journal.data[dateStr]; if(!entry) return;
        const parts = dateStr.split('-'); const d = new Date(parts[0], parts[1]-1, parts[2]);
        document.getElementById('prev-date-num').innerText = d.getDate();
        document.getElementById('prev-date-day').innerText = d.toLocaleDateString('en-US',{month:'long',year:'numeric'});
        const list = document.getElementById('preview-list'); list.innerHTML = '';
        
        // Generate Stats HTML
        let statsHtml = `<div class="grid grid-cols-3 gap-2 mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100">
            <div><div class="text-[9px] text-slate-400 font-bold uppercase">Study</div><div class="text-sm font-black text-slate-700">${entry.study||0}h</div></div>
            <div><div class="text-[9px] text-slate-400 font-bold uppercase">Height</div><div class="text-sm font-black text-slate-700">${entry.height||'--'}</div></div>
            <div><div class="text-[9px] text-slate-400 font-bold uppercase">Exercise</div><div class="text-sm font-black ${entry.exercise==='Yes'?'text-green-500':'text-slate-700'}">${entry.exercise||'No'}</div></div>
        </div>`;

        // NEW: Render Custom Markers in Preview
        if(journal.customMarkers.length > 0 && entry.custom) {
             statsHtml += `<div class="grid grid-cols-3 gap-2 mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100">`;
             journal.customMarkers.forEach(m => {
                 const val = entry.custom[m.id];
                 if(val) {
                     statsHtml += `<div><div class="text-[9px] text-slate-400 font-bold uppercase truncate">${m.icon} ${m.label}</div><div class="text-sm font-black text-slate-700 truncate">${val}</div></div>`;
                 }
             });
             statsHtml += `</div>`;
        }
        
        let gridHtml = '<div class="grid grid-cols-3 gap-2 mb-6">';
        journal.cats.forEach(c => { if(entry[c.id]) { gridHtml += `<div class="bg-white p-2 rounded-lg border border-slate-100 shadow-sm"><div class="text-lg">${c.icon}</div><div class="text-[10px] font-bold text-slate-700 font-mono mt-1">${entry[c.id]}</div></div>`; } });
        gridHtml += '</div>';
        
        let noteHtml = ''; if(entry.htmlContent) { noteHtml = `<div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-xl mb-4 text-slate-700 space-y-2 text-sm" id="preview-content">${entry.htmlContent}</div>`; }
        let imgHtml = ''; if(entry.images && entry.images.length > 0) { imgHtml = `<div class="space-y-3">`; entry.images.forEach(src => imgHtml += `<img src="${src}" class="w-full rounded-xl shadow-md">`); imgHtml += `</div>`; }
        list.innerHTML = statsHtml + gridHtml + noteHtml + imgHtml;
        document.getElementById('preview-overlay').classList.add('active');
    },
    renderHistory: () => {
        const cont = document.getElementById('journal-history'); cont.innerHTML = '';
        const sorted = Object.values(journal.data).sort((a,b) => new Date(b.date) - new Date(a.date));
        sorted.forEach(e => {
            const d = new Date(e.date); 
            // We only show basic summaries in the list item to keep it clean, detailed view is in preview
            cont.innerHTML += `<div onclick="journal.openLogPreview('${e.date}')" class="glass p-3 flex items-center justify-between active:scale-95 transition-transform cursor-pointer"><div class="flex items-center gap-3"><div class="bg-blue-100 text-blue-600 w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs shadow-sm flex-col leading-none pt-1"><span>${d.getDate()}</span><span class="text-[8px] uppercase">${d.toLocaleDateString('en-US',{month:'short'})}</span></div><div><div class="text-xs font-bold text-slate-700">Daily Log</div><div class="text-[10px] text-slate-400 flex gap-2 mt-0.5">${e.study?`<span>ðŸ“š ${e.study}h</span>`:''} ${e.height?`<span>ðŸ“ ${e.height}</span>`:''} ${e.exercise==='Yes'?'<span>ðŸ’ª Yes</span>':''}</div></div></div><i class="fas fa-chevron-right text-slate-300 text-xs"></i></div>`;
        });
    }
};
    // --- HEAVY-DUTY STORAGE ENGINE (INDEXEDDB) ---
    const idb = {
        db: null,
        init: () => new Promise((resolve, reject) => {
            if (idb.db) return resolve(idb.db);
            const req = indexedDB.open('ZenithCoreDB', 1);
            req.onupgradeneeded = e => e.target.result.createObjectStore('store');
            req.onsuccess = e => { idb.db = e.target.result; resolve(idb.db); };
            req.onerror = e => reject(e.target.error);
        }),
        get: async (k) => {
            const db = await idb.init();
            return new Promise(resolve => {
                const req = db.transaction('store', 'readonly').objectStore('store').get(k);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        },
        set: async (k, v) => {
            const db = await idb.init();
            return new Promise(resolve => {
                const tx = db.transaction('store', 'readwrite');
                tx.objectStore('store').put(v, k);
                tx.oncomplete = () => resolve();
            });
        }
    };


        // --- 2. CORE APP ---
        const app = {
            data: [], currParent: null, 
            files: [], programs: [],
            fileGroups: [], projectGroups: [],
            streakProjects: [], // IDs of projects/programs to track
            hierarchy: ['project','task','subtask'], 
            charts: {}, currBlobUrl: null,
            targetGroup: null, dragSrcEl: null, currPreviewDate: null,
            calendarViewMode: 'month',
            
            // --- SCIENTIFIC ADVICE BANK ---
            adviceBank: {
                low: [
                    {m: "The 2-Minute Rule", s: "If a task takes less than 2 minutes, do it now. It creates immediate momentum.", q: "The secret of getting ahead is getting started."},
                    {m: "Pomodoro Technique", s: "Set a timer for 25 minutes. Focus on one task. Take a 5-minute break.", q: "It is not enough to be busy. The question is: what are we busy about?"},
                    {m: "Eat the Frog", s: "Do your hardest task first thing in the morning when willpower is highest.", q: "If it's your job to eat a frog, it's best to do it first thing in the morning."}
                ],
                medium: [
                    {m: "Parkinson's Law", s: "Work expands to fill the time available. Set artificial, tight deadlines.", q: "Work expands so as to fill the time available for its completion."},
                    {m: "Time Blocking", s: "Assign every hour of your day a specific job. Don't leave white space.", q: "Time is what we want most, but what we use worst."},
                    {m: "Flow State Triggers", s: "Match the challenge to your skill level. Too hard = anxiety, too easy = boredom.", q: "May the Force be with you."}
                ],
                high: [
                    {m: "Active Recovery", s: "To sustain high output, you must rest deliberately (walk, sleep, meditate).", q: "Rest is not idleness."},
                    {m: "Eisenhower Matrix", s: "Delegate or delete. You are doing too much. Focus on 'Important & Not Urgent'.", q: "Efficiency is doing things right; effectiveness is doing the right things."},
                    {m: "Kaizen", s: "Look for 1% improvements in your workflow rather than massive changes.", q: "Continuous improvement is better than delayed perfection."}
                ]
            },

            // --- TACTILE MODAL PHYSICS ---
            setupSwipeToClose: () => {
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    const modal = overlay.querySelector('.modal');
                    if (!modal) return;
                    
                    let startY = 0, currentY = 0, isDragging = false;

                    modal.addEventListener('touchstart', (e) => {
                        // Only allow the drag if the user is at the absolute top of the scrollable area
                        if (modal.scrollTop <= 0) {
                            startY = e.touches[0].clientY;
                            isDragging = true;
                            modal.style.transition = 'none'; // Snap to finger instantly
                        }
                    }, {passive: true});

                    modal.addEventListener('touchmove', (e) => {
                        if (!isDragging) return;
                        currentY = e.touches[0].clientY;
                        const deltaY = currentY - startY;
                        
                        if (deltaY > 0) { // Dragging down
                            if (e.cancelable) e.preventDefault(); // Prevent background scrolling
                            modal.style.transform = `translateY(${deltaY}px)`;
                        }
                    }, {passive: false});

                    modal.addEventListener('touchend', () => {
                        if (!isDragging) return;
                        isDragging = false;
                        const deltaY = currentY - startY;
                        
                        // Restore the smooth snap transition
                        modal.style.transition = 'transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        
                        if (deltaY > 120) { // The threshold: Commit to the swipe to close
                            overlay.classList.remove('open');
                            setTimeout(() => { modal.style.transform = ''; }, 300); // Reset position after it hides
                        } else {
                            // Snap back to top if they didn't pull far enough
                            modal.style.transform = 'translateY(0)';
                            setTimeout(() => { modal.style.transform = ''; }, 300);
                        }
                    });
                });
            },



            // --- NATIVE APP EXPERIENCE ---
            deferredPrompt: null,
            updateThemeColor: () => {
                // Hijacks the phone's status bar to match the UI perfectly
                const isDark = document.documentElement.classList.contains('dark');
                const color = isDark ? '#09090b' : '#f8fafc';
                let metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) metaTheme.content = color;
            },
                        installPWA: async () => {
                if (app.deferredPrompt) {
                    app.deferredPrompt.prompt();
                    const { outcome } = await app.deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        app.deferredPrompt = null;
                        document.getElementById('install-pwa-btn').style.display = 'none';
                    }
                } else {
                    alert("INSTALLATION BLOCKED: Android is rejecting this app. To fix this: \n1. You CANNOT run this from a local file. It must be hosted on a live HTTPS URL (like GitHub Pages or Vercel).\n2. Your manifest.json and sw.js must be in the same folder.\n3. Your 192x192 and 512x512 icons must exist.");
                }
            },

                        init: async () => {
                // Register Service Worker (Mandatory for Android PWA Install)
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js').catch(err => console.error("Service Worker failed.", err));
                }

                // Listen for Native Install Capability
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    app.deferredPrompt = e;
                });

                // Sync status bar color on boot & setup physics
                app.updateThemeColor();
                app.setupSwipeToClose();

                // Initialize Theme Memory
                if (localStorage.getItem('zenith_theme') === 'dark') {
                    document.documentElement.classList.add('dark');
                    const btn = document.getElementById('theme-toggle-btn');
                    if(btn) { btn.innerHTML = '<i class="fas fa-sun"></i> Engage Light Mode'; btn.className = 'w-full py-4 mb-3 bg-amber-100 text-amber-600 font-bold rounded-xl flex items-center justify-center gap-2 transition-colors'; }
                    app.updateThemeColor();
                }

                // --- INDEXEDDB DATA MIGRATION & BOOT ---
                try {
                    // One-time rescue: Move data from LocalStorage to the new hard drive database
                    if (localStorage.getItem('zenith_minimal_v1')) {
                        await idb.set('zenith_minimal_v1', JSON.parse(localStorage.getItem('zenith_minimal_v1')));
                        await idb.set('zenith_files', JSON.parse(localStorage.getItem('zenith_files') || '[]'));
                        await idb.set('zenith_programs', JSON.parse(localStorage.getItem('zenith_programs') || '[]'));
                        await idb.set('zenith_file_groups', JSON.parse(localStorage.getItem('zenith_file_groups') || '["General"]'));
                        await idb.set('zenith_project_groups', JSON.parse(localStorage.getItem('zenith_project_groups') || '["General"]'));
                        await idb.set('zenith_streak_projects', JSON.parse(localStorage.getItem('zenith_streak_projects') || '[]'));
                        
                        // Destroy old bottleneck
                        localStorage.removeItem('zenith_minimal_v1'); 
                    }

                    // Boot from Hard Drive
                    app.data = await idb.get('zenith_minimal_v1') || [];
                    app.files = await idb.get('zenith_files') || [];
                    app.programs = await idb.get('zenith_programs') || [];
                    app.fileGroups = await idb.get('zenith_file_groups') || ['General'];
                    app.projectGroups = await idb.get('zenith_project_groups') || ['General'];
                    app.streakProjects = await idb.get('zenith_streak_projects') || [];
                } catch(e) { app.data=[]; app.files=[]; }

                // Restore File Widget State
                if(localStorage.getItem('zenith_files_min') === 'true') {
                    const body = document.getElementById('files-body');
                    const chevron = document.getElementById('files-chevron');
                    if(body && chevron) {
                        body.classList.add('hidden');
                        chevron.style.transform = 'rotate(180deg)';
                    }
                }

                app.renderList(); app.renderFiles(); 
                
                await journal.init(); // Boot journal data asynchronously
                
                app.initSeason(); app.updateStreakDisplay();
            },

            initSeason: () => {
                const month = new Date().getMonth(); 
                const overlay = document.getElementById('season-overlay');
                let html = '';
                if (month === 11 || month === 0 || month === 1) { 
                    for(let i=0; i<30; i++) html += `<div class="snowflake" style="left:${Math.random()*100}vw; animation-duration:${Math.random()*5+5}s; font-size:${Math.random()*10+10}px; animation-delay:-${Math.random()*5}s">â„ï¸</div>`;
                }
                overlay.innerHTML = html;
            },
            
                      save: () => {
                // Fire-and-forget asynchronous saving to device hard drive
                idb.set('zenith_minimal_v1', app.data);
                idb.set('zenith_files', app.files);
                idb.set('zenith_programs', app.programs);
                idb.set('zenith_file_groups', app.fileGroups);
                idb.set('zenith_project_groups', app.projectGroups);
                idb.set('zenith_streak_projects', app.streakProjects);
            },

            
            getIST: () => new Date().toLocaleDateString('en-CA', {timeZone: 'Asia/Kolkata'}),
           
            toggleFilesWidget: () => {
                const body = document.getElementById('files-body');
                const chevron = document.getElementById('files-chevron');
                if(body.classList.contains('hidden')) {
                    body.classList.remove('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                    localStorage.setItem('zenith_files_min', 'false');
                } else {
                    body.classList.add('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                    localStorage.setItem('zenith_files_min', 'true');
                }
            },

 
            // --- GROUP MANAGEMENT ---
            addGroup: (type) => {
                const name = prompt("Enter new Group Name:");
                if(!name) return;
                if(type === 'file') {
                    if(!app.fileGroups.includes(name)) { app.fileGroups.push(name); app.save(); app.renderFiles(); }
                } else {
                    if(!app.projectGroups.includes(name)) { app.projectGroups.push(name); app.save(); app.renderList(); }
                }
            },
            
            deleteGroup: (type, name) => {
                if(!confirm(`Delete group "${name}"? Items will move to General.`)) return;
                if(type === 'file') {
                    app.fileGroups = app.fileGroups.filter(g => g !== name);
                    app.files.forEach(f => { if(f.group === name) f.group = 'General'; });
                } else {
                    app.projectGroups = app.projectGroups.filter(g => g !== name);
                    app.data.forEach(p => { if(p.group === name) p.group = 'General'; });
                }
                app.save(); 
                if(type === 'file') app.renderFiles(); else app.renderList();
            },

            // --- FILES ---
            prepFileUpload: (groupName) => { app.targetGroup = groupName; document.getElementById('file-upload-input').click(); },
            handleFileUpload: (input) => {
                if(input.files && input.files[0]) {
                    const file = input.files[0];
                    if(file.size > 2097152) { alert("File too large! Max 2MB."); return; } 
                    
                    const currentTarget = app.targetGroup || 'General'; 
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        app.files.push({id: Date.now().toString(), name: file.name, link: e.target.result, type: file.type, group: currentTarget});
                        app.save(); app.renderFiles();
                    };
                    reader.readAsDataURL(file);
                }
                app.targetGroup = null; 
            },
            delFile: (id) => { if(confirm("Delete file?")) { app.files = app.files.filter(f => f.id !== id); app.save(); app.renderFiles(); } },
            
            renderFiles: () => {
                const container = document.getElementById('files-container'); container.innerHTML = '';
                const empty = document.getElementById('files-empty');
                if(app.files.length === 0 && app.fileGroups.length === 1) { empty.classList.remove('hidden'); return; }
                empty.classList.add('hidden');

                app.fileGroups.forEach(grp => {
                    const groupFiles = app.files.filter(f => (f.group || 'General') === grp);
                    const header = document.createElement('div');
                    header.className = 'group-header';
                    header.innerHTML = `
                        <span class="group-title">${grp}</span>
                        <div class="flex gap-2">
                             <button onclick="event.stopPropagation(); app.prepFileUpload('${grp}')" class="w-6 h-6 flex items-center justify-center bg-white rounded-md text-indigo-500 shadow-sm"><i class="fas fa-plus text-[10px]"></i></button>
                             ${grp !== 'General' ? `<button onclick="event.stopPropagation(); app.deleteGroup('file','${grp}')" class="w-6 h-6 flex items-center justify-center bg-white rounded-md text-red-400 shadow-sm"><i class="fas fa-trash text-[10px]"></i></button>` : ''}
                        </div>`;
                    
                    const list = document.createElement('div'); list.className = 'space-y-2 mb-4 pl-2';
                    if(groupFiles.length === 0) list.innerHTML = '<div class="text-[9px] text-slate-300 italic pl-2">Empty</div>';
                    groupFiles.forEach(f => {
                        const isImg = f.type && f.type.startsWith('image');
                        const icon = isImg ? 'fa-image' : 'fa-file-alt';
                        list.innerHTML += `<div class="file-item bg-white rounded-lg p-2 flex items-center justify-between gap-3"><div class="flex items-center gap-3 overflow-hidden flex-1 cursor-pointer" onclick="app.previewFile('${f.id}')"><div class="w-8 h-8 rounded bg-slate-100 flex items-center justify-center text-slate-400"><i class="fas ${icon}"></i></div><div class="truncate"><div class="text-xs font-bold text-slate-700 truncate">${f.name}</div></div></div><button onclick="app.delFile('${f.id}')" class="text-slate-300 hover:text-red-500 px-3"><i class="fas fa-trash-alt"></i></button></div>`;
                    });
                    container.appendChild(header); container.appendChild(list);
                });
            },

            // --- FILE PREVIEW ---
            base64ToBlob: (base64, type) => {
                try {
                    const arr = base64.split(','); const mime = arr[0].match(/:(.*?);/)[1];
                    const bstr = atob(arr[1]); let n = bstr.length; const u8arr = new Uint8Array(n);
                    while(n--){ u8arr[n] = bstr.charCodeAt(n); }
                    return new Blob([u8arr], {type:type});
                } catch(e) { console.log(e); return null; }
            },
            previewFile: (id) => {
                const f = app.files.find(x => x.id === id); if(!f) return;
                const viewer = document.getElementById('file-viewer-modal');
                document.getElementById('fv-title').innerText = f.name;
                const body = document.getElementById('fv-body');
                const extLink = document.getElementById('fv-external-link');
                
                if (app.currBlobUrl) URL.revokeObjectURL(app.currBlobUrl);
                
                if (f.type.startsWith('image/')) {
                    body.innerHTML = `<img src="${f.link}">`;
                    extLink.href = f.link;
                } else {
                    try {
                        const blob = app.base64ToBlob(f.link, f.type);
                        if(blob) {
                             app.currBlobUrl = URL.createObjectURL(blob);
                             extLink.href = app.currBlobUrl;
                             body.innerHTML = `<object data="${app.currBlobUrl}" type="${f.type}" width="100%" height="100%"><div class="flex items-center justify-center h-full text-slate-400 text-sm">Preview unavailable</div></object>`;
                        } else { body.innerHTML = '<div class="p-5 text-center text-red-500">Error loading preview</div>'; }
                    } catch(e) { body.innerHTML = '<div class="p-5 text-center text-red-500">Error loading preview</div>'; }
                }
                viewer.classList.remove('hidden-viewer', 'minimized', 'maximized'); viewer.classList.add('normal');
            },
            closeFileViewer: () => { document.getElementById('file-viewer-modal').classList.add('hidden-viewer'); },
            toggleFileMaximize: () => { const v = document.getElementById('file-viewer-modal'); v.classList.toggle('maximized'); v.classList.toggle('normal'); },
            toggleFileMinimize: () => { const v = document.getElementById('file-viewer-modal'); v.classList.add('minimized'); v.classList.remove('normal','maximized'); },
            restoreFileViewer: () => { const v = document.getElementById('file-viewer-modal'); if(v.classList.contains('minimized')) { v.classList.remove('minimized'); v.classList.add('normal'); } },

            // --- PROJECTS & TASKS ---
            drill: (id) => { app.currParent = id; app.renderList(); },
            goUp: () => { if(app.currParent) { const c = app.data.find(x=>x.id===app.currParent); app.currParent = c?c.parentId:null; app.renderList(); } },
                                    toggle: (id) => { 
                const i = app.data.find(x => x.id === id); 
                if(i) { 
                    if (!i.completed) {
                        // Brutal Honesty Protocol: Check for uncompleted children
                        const pendingChildren = app.data.filter(x => x.parentId === id && x.type !== 'event' && !x.completed && !x.failed);
                        if (pendingChildren.length > 0) {
                            alert(`DENIED. You cannot complete "${i.title}" until its ${pendingChildren.length} pending sub-items are finished or logged as failed.`);
                            return;
                        }
                    }

                    i.completed = !i.completed; 
                    if(i.completed) i.failed = false; 
                    i.completed ? i.completedAt = app.getIST() : delete i.completedAt; 
                    app.save(); app.renderList(); app.updateStreakDisplay(); 
                    if(i.completed && i.type !== 'event') dopamine.trigger(); 
                    if(i.type !== 'event' && !document.getElementById('view-list').classList.contains('hidden')) app.renderList(); 
                } 
            },

                        toggleFail: (id) => {
                const i = app.data.find(x => x.id === id);
                if(i) {
                    if (!i.failed) {
                        const reason = prompt("State your reason for failure. Be brutally honest:");
                        if (reason === null) return; // Cancelled
                        i.failed = true;
                        i.failReason = reason.trim() === "" ? "No excuse provided." : reason;
                        i.completed = false; 
                        delete i.completedAt;
                        dopamine.punish();
                    } else {
                        // Reverting failed state
                        i.failed = false;
                        delete i.failReason;
                    }
                    app.save(); 
                    app.renderList();
                    if(document.getElementById('view-stats') && !document.getElementById('view-stats').classList.contains('hidden')) app.renderStats();
                }
            },
          
  reviveTask: (id) => {
                const i = app.data.find(x => x.id === id);
                if(i && i.failed) {
                    i.failed = false;
                    delete i.failReason;
                    app.save();
                    app.renderList();
                    if(document.getElementById('view-stats') && !document.getElementById('view-stats').classList.contains('hidden')) app.renderStats();
                    if(!document.getElementById('view-calendar').classList.contains('hidden')) app.renderQuarterlyBoard();
                }
            },
            
            
            triggerSuccessAnimation: () => {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                const popup = document.getElementById('success-popup');
                popup.classList.add('active');
                setTimeout(() => popup.classList.remove('active'), 2000);
            },
            delItem: (id) => { if(!confirm('Delete?')) return; const rec = (pid) => { app.data.filter(x => x.parentId === pid).forEach(k => rec(k.id)); app.data = app.data.filter(x => x.id !== pid); }; rec(id); app.save(); app.renderList(); },
            getLevel: (pid) => { if(!pid) return 'project'; const p=app.data.find(x=>x.id===pid); if(!p || p.type==='event') return 'subtask'; const i=app.hierarchy.indexOf(p.type); return (i!==-1 && i<app.hierarchy.length-1)?app.hierarchy[i+1]:'subtask'; },
            
            // --- DRAG AND DROP ---
            handleDragStart: (e) => { app.dragSrcEl = e.target; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', e.target.innerHTML); e.target.classList.add('dragging'); },
            handleDragOver: (e) => { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; },
                        handleDragEnter: (e) => { const t = e.target.closest('.draggable-item') || e.target.closest('.group-header'); if (t && t !== app.dragSrcEl) t.classList.add('drag-over'); },
            handleDragLeave: (e) => { const t = e.target.closest('.draggable-item') || e.target.closest('.group-header'); if (t) t.classList.remove('drag-over'); },
            handleDrop: (e) => {
                if (e.stopPropagation) e.stopPropagation();
                
                // Scenario 1: Dropped onto a category header directly
                const groupTarget = e.target.closest('.group-header');
                if (groupTarget && app.dragSrcEl) {
                    const sId = app.dragSrcEl.getAttribute('data-id');
                    const item = app.data.find(x => x.id === sId);
                    if (item) {
                        item.group = groupTarget.getAttribute('data-group');
                        app.save(); app.renderList();
                    }
                    return false;
                }

                // Scenario 2: Dropped onto another task inside a category
                const target = e.target.closest('.draggable-item');
                if (app.dragSrcEl && target && app.dragSrcEl !== target) {
                    const sId = app.dragSrcEl.getAttribute('data-id'); const tId = target.getAttribute('data-id');
                    const sIdx = app.data.findIndex(x => x.id === sId); const tIdx = app.data.findIndex(x => x.id === tId);
                    if (sIdx > -1 && tIdx > -1) { 
                        // Force the dragged item to adopt the target's group if on the front page
                        if (!app.currParent) app.data[sIdx].group = app.data[tIdx].group || 'General';
                        const [m] = app.data.splice(sIdx, 1); app.data.splice(tIdx, 0, m); 
                        app.save(); app.renderList();
                    }
                } return false;
            },
            handleDragEnd: (e) => { app.dragSrcEl = null; document.querySelectorAll('.draggable-item, .group-header').forEach(i => { i.classList.remove('drag-over'); i.classList.remove('dragging'); }); app.renderList(); },

            
            toggleVisibility: (id) => {
                const item = app.data.find(x => x.id === id);
                if (item) {
                    item.showInCal = (item.showInCal === undefined) ? false : !item.showInCal;
                    app.save();
                    app.renderList();
                }
            },

                        renderList: () => {
                const list = document.getElementById('items-list'); list.innerHTML = '';
                const title = document.getElementById('page-title'); const subtitle = document.getElementById('page-subtitle');
                const back = document.getElementById('back-btn');
                const itemsHeader = document.getElementById('items-header');
                const today = app.getIST();

                // 1. Reality Check (Anti-Delusion Protocol)
                const activeToday = app.data.filter(x => !x.completed && !x.failed && x.type !== 'event' && x.deadline === today);
                const banner = document.getElementById('reality-check-banner');
                const msg = document.getElementById('reality-check-msg');
                if (activeToday.length > 5) {
                    banner.classList.remove('hidden');
                    msg.innerText = `You have scheduled ${activeToday.length} items for today. You are confusing list-making with productivity. Defer tasks or you will fail.`;
                } else {
                    banner.classList.add('hidden');
                }

                // 2. Tactical Daily Progress Bar
                const todayTotalTasks = app.data.filter(x => x.type !== 'event' && !x.failed && x.deadline === today);
                const todayDone = todayTotalTasks.filter(x => x.completed).length;
                const dailyPct = todayTotalTasks.length === 0 ? 0 : Math.round((todayDone / todayTotalTasks.length) * 100);
                const progBar = document.getElementById('daily-progress-bar');
                if (progBar) {
                    progBar.style.width = dailyPct + '%';
                    progBar.style.backgroundColor = dailyPct === 100 ? '#22c55e' : (dailyPct > 50 ? '#3b82f6' : '#f59e0b');
                }

                if(!app.currParent) { 
                    title.innerText = 'Glorious Purpose'; title.className = "font-black text-2xl leading-none truncate glorious-text";
                    subtitle.innerText = 'ACTIVE DUTY'; back.classList.add('hidden'); itemsHeader.classList.remove('hidden');
                    
                    app.projectGroups.forEach(grp => {
                        // Separate Active Tasks and Stamped (Completed) Tasks
                        const activeItems = app.data.filter(x => !x.parentId && x.type !== 'event' && !x.failed && !x.completed && (x.group || 'General') === grp);
                        const stampedItems = app.data.filter(x => !x.parentId && x.type !== 'event' && !x.failed && x.completed && !x.partial && (x.group || 'General') === grp);
                        
                        const header = document.createElement('div');
                        header.className = 'group-header transition-colors';
                        header.setAttribute('data-group', grp);
                        header.addEventListener('dragover', app.handleDragOver); header.addEventListener('dragenter', app.handleDragEnter); header.addEventListener('dragleave', app.handleDragLeave); header.addEventListener('drop', app.handleDrop);
                        header.innerHTML = `<span class="group-title pointer-events-none">${grp}</span>${grp!=='General' ? `<button onclick="app.deleteGroup('project','${grp}')" class="text-slate-300 hover:text-red-500 z-10 relative"><i class="fas fa-trash pointer-events-none"></i></button>` : ''}`;
                        list.appendChild(header);
                        
                        if(activeItems.length === 0 && stampedItems.length === 0) { 
                            list.innerHTML += '<div class="text-[9px] text-slate-300 italic pl-2 mb-2">Empty</div>'; 
                        } else { 
                            activeItems.forEach(i => list.appendChild(app.createItemEl(i))); 
                            stampedItems.forEach(i => list.appendChild(app.createStampEl(i))); // Render the ghost stamps
                        }
                    });
                    
                    const activeOrphans = app.data.filter(x => !x.parentId && x.type !== 'event' && !x.failed && !x.completed && !app.projectGroups.includes(x.group || 'General'));
                    const stampedOrphans = app.data.filter(x => !x.parentId && x.type !== 'event' && !x.failed && x.completed && !x.partial && !app.projectGroups.includes(x.group || 'General'));
                    
                    if(activeOrphans.length > 0 || stampedOrphans.length > 0) { 
                        const header = document.createElement('div'); header.className = 'group-header transition-colors'; header.setAttribute('data-group', 'General');
                        header.addEventListener('dragover', app.handleDragOver); header.addEventListener('dragenter', app.handleDragEnter); header.addEventListener('dragleave', app.handleDragLeave); header.addEventListener('drop', app.handleDrop);
                        header.innerHTML = `<span class="group-title pointer-events-none">Unsorted</span>`;
                        list.appendChild(header); 
                        activeOrphans.forEach(i => list.appendChild(app.createItemEl(i))); 
                        stampedOrphans.forEach(i => list.appendChild(app.createStampEl(i)));
                    }

                } else { 
                    const p = app.data.find(x => x.id === app.currParent);
                    title.innerText = p.title; title.className = "font-bold text-xl leading-none truncate text-slate-800";
                    subtitle.innerText = p.type.toUpperCase(); back.classList.remove('hidden'); itemsHeader.classList.add('hidden');
                    
                    // Inside a Project: Separate Active and Stamped
                    const activeItems = app.data.filter(x => x.parentId === app.currParent && x.type !== 'event' && !x.failed && !x.completed);
                    const stampedItems = app.data.filter(x => x.parentId === app.currParent && x.type !== 'event' && !x.failed && x.completed && !x.partial);
                    
                    if(activeItems.length === 0 && stampedItems.length === 0) {
                        document.getElementById('empty-state').classList.remove('hidden'); 
                    } else {
                        document.getElementById('empty-state').classList.add('hidden');
                        activeItems.forEach(i => list.appendChild(app.createItemEl(i)));
                        stampedItems.forEach(i => list.appendChild(app.createStampEl(i))); // Render the ghost stamps
                    }
                }
            },

                        createItemEl: (i) => {
                const subCount = app.data.filter(x => x.parentId === i.id && x.type !== 'event' && !x.completed && !x.failed).length;
                const isVisible = i.showInCal !== false; 
                const isFailed = i.failed === true;
                
                let isStagnant = false;
                if(i.start && !i.completed && !i.failed) {
                    const daysOld = Math.floor((new Date(app.getIST()) - new Date(i.start)) / (1000 * 60 * 60 * 24));
                    if(daysOld > 2) isStagnant = true;
                }

                const el = document.createElement('div');
                el.className = `glass p-4 card mb-3 relative overflow-hidden flex items-center gap-3 tap-scale draggable-item ${isStagnant ? 'task-stagnant' : ''}`;
                el.setAttribute('draggable', 'true'); el.setAttribute('data-id', i.id);
                el.addEventListener('dragstart', app.handleDragStart); el.addEventListener('dragover', app.handleDragOver); el.addEventListener('dragenter', app.handleDragEnter); el.addEventListener('dragleave', app.handleDragLeave); el.addEventListener('drop', app.handleDrop); el.addEventListener('dragend', app.handleDragEnd);
                el.innerHTML = `
                    <div onclick="app.toggle('${i.id}')" class="w-6 h-6 rounded-full border-2 ${i.completed?'bg-green-500 border-green-500 text-white':isFailed?'border-red-300 bg-red-50':'border-slate-300'} flex items-center justify-center cursor-pointer z-10 no-drag">
                        ${i.completed?'<i class="fas fa-check text-[10px]"></i>':isFailed?'<i class="fas fa-times text-[10px] text-red-500"></i>':''}
                    </div>
                    <div class="flex-1 cursor-pointer" onclick="app.drill('${i.id}')">
                        <div class="flex items-center mb-1 gap-2">
                            <span class="text-[9px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded uppercase">${i.type}</span>
                            <span class="text-[10px] font-bold ${i.priority==='High'?'text-red-500':i.priority==='Medium'?'text-amber-500':'text-blue-500'} uppercase">${i.priority}</span>
                            ${subCount > 0 ? `<span class="text-[9px] font-bold text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100"><i class="fas fa-code-branch mr-1"></i>${subCount}</span>` : ''}
                        </div>
                        <h3 class="font-bold text-slate-800 ${i.completed?'line-through text-slate-400':isFailed?'line-through text-red-400':''}">${i.title}</h3>
                        <div class="text-xs text-slate-400 mt-1">${i.deadline}</div>
                        ${isStagnant ? `<div class="text-[9px] font-bold text-orange-600 mt-2 bg-orange-100 p-1 rounded border border-orange-200 uppercase tracking-wide inline-block"><i class="fas fa-hourglass-half mr-1"></i> Stagnant</div>` : ''}
                        ${isFailed ? `<div class="text-[9px] font-mono font-bold text-red-600 mt-2 bg-red-50 p-1.5 rounded border border-red-200 uppercase tracking-wide inline-block">EXCUSE: ${i.failReason || 'None'}</div>` : ''}
                    </div>
                    <div class="flex flex-col gap-3 z-10 no-drag">
                        <button onclick="app.toggleVisibility('${i.id}')" class="${isVisible ? 'text-blue-500' : 'text-slate-300'} hover:text-blue-600"><i class="fas ${isVisible ? 'fa-eye' : 'fa-eye-slash'}"></i></button>
                        <button onclick="app.toggleFail('${i.id}')" class="${isFailed ? 'text-red-500' : 'text-slate-300'} hover:text-red-500" title="Mark as Failed"><i class="fas fa-times-circle"></i></button>
                        ${!app.currParent ? `<button onclick="app.downloadReport(null, '${i.id}')" class="text-slate-300 hover:text-blue-500"><i class="fas fa-file-invoice"></i></button>` : ''}
                        <button onclick="app.markPartial(event, '${i.id}')" class="text-slate-300 hover:text-orange-500" title="Give Up (Partial Complete)"><i class="fas fa-sign-out-alt"></i></button>
                        <button onclick="app.openModal('edit','${i.id}')" class="text-slate-300 hover:text-blue-500"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="app.delItem('${i.id}')" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>`;
                return el;
                
            },
                        createStampEl: (i) => {
                const el = document.createElement('div');
                el.className = "glass p-4 mb-3 relative flex items-center gap-3 stamp-card";
                
                // Deterministic random stamp style based on the task ID
                const styles = [
                    { class: 'stamp-green', text: 'EXECUTED' },
                    { class: 'stamp-purple', text: 'CRUSHED' },
                    { class: 'stamp-blue', text: 'CLEARED' },
                    { class: 'stamp-gold', text: 'MASTERED' }
                ];
                // Use the timestamp ID to pick a consistent style for this specific task
                const num = parseInt(i.id.slice(-5), 10) || 0;
                const style = styles[num % styles.length];

                el.innerHTML = `
                    <div class="w-6 h-6 rounded-full border-2 border-slate-200 bg-slate-50 flex items-center justify-center opacity-50 grayscale">
                        <i class="fas fa-check text-[10px] text-slate-300"></i>
                    </div>
                    <div class="flex-1 opacity-50">
                        <h3 class="font-bold text-slate-500 line-through">${i.title}</h3>
                        <div class="text-[10px] text-slate-400 font-mono mt-1">Logged: ${i.completedAt ? i.completedAt.split('T')[0] : 'Unknown'}</div>
                    </div>
                    <div class="stamp-mark ${style.class}">${style.text}</div>
                `;
                return el;
            },
            
            markPartial: (e, id) => {
                if(!confirm("Give up on the remaining components? This will be logged as a partial failure.")) return;
                const card = e.target.closest('.card');
                if(card) {
                    card.classList.add('thanos-snap');
                    setTimeout(() => {
                        const i = app.data.find(x => x.id === id);
                        if(i) {
                            i.completed = true;
                            i.partial = true;
                            i.completedAt = app.getIST();
                            app.save();
                            app.renderList();
                        }
                    }, 1400); // Waits for the snap dust animation to finish
                }
            },
            createDullVaultNode: (i) => {
                const subCount = app.data.filter(x => x.parentId === i.id && x.type !== 'event').length;
                let parentContext = '';
                if (i.parentId) {
                    const p = app.data.find(x => x.id === i.parentId);
                    if (p) parentContext = `<div class="text-[9px] text-slate-500 uppercase tracking-widest mt-1"><i class="fas fa-level-up-alt mr-1"></i>Abandoned from: ${p.title}</div>`;
                }

                const el = document.createElement('div');
                el.className = "vault-dull-card p-4 rounded-xl mb-2 flex items-center gap-4 cursor-pointer transition-colors";
                el.onclick = () => app.vaultDrill(i.id);
                el.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-300 text-slate-500 flex items-center justify-center shadow-inner"><i class="fas fa-minus text-xs"></i></div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[9px] font-bold bg-slate-300 text-slate-600 px-2 py-0.5 rounded uppercase">PARTIAL</span>
                                ${subCount > 0 ? `<span class="text-[9px] font-bold text-slate-500 bg-slate-200 px-1.5 py-0.5 rounded"><i class="fas fa-code-branch mr-1"></i>${subCount} nested</span>` : ''}
                            </div>
                            <button onclick="event.stopPropagation(); app.vaultRevive('${i.id}')" class="text-[9px] font-bold bg-slate-200 hover:bg-slate-300 text-slate-600 px-2 py-1 rounded transition-colors border border-slate-300"><i class="fas fa-undo mr-1"></i> TRY AGAIN</button>
                        </div>
                        <h3 class="font-bold text-slate-500 line-through decoration-slate-400">${i.title}</h3>
                        ${parentContext}
                        <div class="text-[10px] text-slate-400 font-mono mt-1">Given up: ${i.completedAt ? i.completedAt.split('T')[0] : 'Unknown'}</div>
                    </div>
                    <i class="fas fa-chevron-right text-slate-300 ml-1"></i>
                `;
                return el;
            },
            

            // --- THE VAULT LOGIC ---
            currVaultParent: null,
            openVault: () => {
                const overlay = document.getElementById('vault-overlay');
                if(!overlay) return alert("Vault HTML is missing!");
                overlay.classList.add('active');
                app.currVaultParent = null; 
                app.renderVault();
            },
            closeVault: () => { document.getElementById('vault-overlay').classList.remove('active'); },
            vaultDrill: (id) => { app.currVaultParent = id; app.renderVault(); },
            vaultGoUp: () => { 
                if(app.currVaultParent) { 
                    const c = app.data.find(x => x.id === app.currVaultParent); 
                    app.currVaultParent = c ? c.parentId : null; 
                    app.renderVault(); 
                } 
            },
            vaultRevive: (id) => {
                const i = app.data.find(x => x.id === id);
                if(i) {
                    i.completed = false;
                    delete i.completedAt;
                    if(i.partial) delete i.partial;
                    app.save();
                    app.renderVault(); // Refreshes the Vault UI
                    app.renderList();  // Puts it back on the Track screen
                    app.updateStreakDisplay();
                }
            },
                        renderVault: () => {
                const list = document.getElementById('vault-list'); list.innerHTML = '';
                const title = document.getElementById('vault-title');
                const backBtn = document.getElementById('vault-back-btn');

                if (!app.currVaultParent) {
                    title.innerText = "Root Categories"; backBtn.classList.add('hidden');
                    let foundAny = false;

                    app.projectGroups.forEach(grp => {
                        const items = app.data.filter(x => x.completed && !x.partial && !x.parentId && x.type !== 'event' && (x.group || 'General') === grp);
                        if (items.length > 0) {
                            foundAny = true;
                            list.innerHTML += `<div class="group-header bg-green-50 border-green-200 mt-4"><span class="group-title text-green-700">${grp}</span></div>`;
                            items.forEach(i => list.appendChild(app.createVaultNode(i)));
                        }
                    });
                    
                    const orphans = app.data.filter(x => x.completed && !x.partial && !x.parentId && x.type !== 'event' && !app.projectGroups.includes(x.group || 'General'));
                    if(orphans.length > 0) {
                        foundAny = true;
                        list.innerHTML += `<div class="group-header bg-green-50 border-green-200 mt-4"><span class="group-title text-green-700">Unsorted</span></div>`;
                        orphans.forEach(i => list.appendChild(app.createVaultNode(i)));
                    }

                    // The Graveyard of Half-Measures (Pulls ALL partials, destroying hierarchy)
                    const partials = app.data.filter(x => x.completed && x.partial && x.type !== 'event')
                                            .sort((a,b) => new Date(b.completedAt || 0) - new Date(a.completedAt || 0));
                    
                    if(partials.length > 0) {
                        foundAny = true;
                        list.innerHTML += `<div class="mt-8 border-t-2 border-dashed border-slate-300 pt-4"><div class="group-header bg-slate-200 border-slate-300"><span class="group-title text-slate-600"><i class="fas fa-battery-half mr-2"></i>Half-Measures (Given Up)</span></div></div>`;
                        partials.forEach(i => list.appendChild(app.createDullVaultNode(i)));
                    }

                    if (!foundAny) list.innerHTML = `<div class="text-center text-slate-400 mt-10 italic">The Vault is empty. Get to work.</div>`;

                } else {
                    const parent = app.data.find(x => x.id === app.currVaultParent);
                    title.innerText = parent ? parent.title : "Items"; backBtn.classList.remove('hidden');
                    
                    const items = app.data.filter(x => x.completed && !x.partial && x.parentId === app.currVaultParent && x.type !== 'event');
                    const partials = app.data.filter(x => x.completed && x.partial && x.parentId === app.currVaultParent && x.type !== 'event');
                    
                    if(items.length === 0 && partials.length === 0) {
                        list.innerHTML = `<div class="text-center text-slate-400 mt-10 italic">No completed sub-items.</div>`;
                    } else {
                        items.forEach(i => list.appendChild(app.createVaultNode(i)));
                        if (partials.length > 0) {
                            list.innerHTML += `<div class="mt-6 border-t border-slate-300 pt-4 mb-2"><span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Abandoned Sub-Items</span></div>`;
                            partials.forEach(i => list.appendChild(app.createDullVaultNode(i)));
                        }
                    }
                }
            },
            createVaultNode: (i) => {
                const subCount = app.data.filter(x => x.parentId === i.id && x.completed && x.type !== 'event').length;
                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-xl border border-green-100 shadow-sm mb-2 flex items-center gap-4 cursor-pointer hover:bg-green-50 transition-colors";
                el.onclick = () => app.vaultDrill(i.id);
                el.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center shadow-inner shadow-green-700/50"><i class="fas fa-check text-xs"></i></div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[9px] font-bold bg-green-100 text-green-700 px-2 py-0.5 rounded uppercase">${i.type}</span>
                                ${subCount > 0 ? `<span class="text-[9px] font-bold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"><i class="fas fa-code-branch mr-1"></i>${subCount} nested</span>` : ''}
                            </div>
                            <button onclick="event.stopPropagation(); app.vaultRevive('${i.id}')" class="text-[9px] font-bold bg-slate-100 hover:bg-slate-200 text-slate-500 px-2 py-1 rounded transition-colors border border-slate-200"><i class="fas fa-undo mr-1"></i> PULL BACK</button>
                        </div>
                        <h3 class="font-bold text-slate-700">${i.title}</h3>
                        <div class="text-[10px] text-slate-400 font-mono mt-1">Completed: ${i.completedAt ? i.completedAt.split('T')[0] : 'Unknown'}</div>
                    </div>
                    <i class="fas fa-chevron-right text-slate-300 ml-1"></i>
                `;
                return el;
            },

            // --- CALENDAR & BOARD ---
           
            setCalendarMode: (mode) => {
                app.calendarViewMode = mode;
                document.getElementById('btn-mode-month').className = mode === 'month' ? 'flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-700' : 'flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500';
                document.getElementById('btn-mode-board').className = mode === 'board' ? 'flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-700' : 'flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500';
                
                if (mode === 'month') {
                    document.getElementById('cal-grid-container').classList.remove('hidden');
                    document.getElementById('board-view-container').classList.add('hidden');
                    app.renderCalendar();
                } else {
                    document.getElementById('cal-grid-container').classList.add('hidden');
                    document.getElementById('board-view-container').classList.remove('hidden');
                    app.renderQuarterlyBoard();
                }
            },

            renderCalendar: () => {
                const grid = document.getElementById('cal-grid-container'); grid.innerHTML = '';
                const today = app.getIST(); let curr = new Date(2026, 0, 1); const end = new Date(2026, 2, 15);
                while(curr <= end) {
                    const dStr = curr.toLocaleDateString('en-CA'); const dNum = curr.getDate(); const dMonth = curr.toLocaleDateString('en-US', {month:'short'});
                    const items = [...app.data.filter(x=>x.type==='event'&&x.deadline===dStr), ...app.data.filter(x=>x.type!=='event'&&!x.completed&&x.deadline===dStr&&x.showInCal!==false)];
                    let slots = ''; 
                    for(let i=0; i<5; i++) { 
                        if(items[i]) { 
                            const cls = items[i].type==='event'?'bg-Event':`bg-${items[i].priority}`; 
                            slots+=`<div class="slot ${cls}">${items[i].title}</div>`; 
                        } else { slots += `<div class="slot slot-empty"></div>`; }
                    }
                    grid.innerHTML += `<div class="cal-day-box ${dStr===today?'is-today':''}" onclick="app.openTaskPreview('${dStr}')"><div class="text-[10px] font-bold text-slate-400 uppercase">${dNum} ${dMonth}</div><div class="cal-slots">${slots}</div></div>`;
                    curr.setDate(curr.getDate()+1);
                }
            },

            // --- QUARTERLY BOARD LOGIC ---
                        renderQuarterlyBoard: () => {
                // Clear all quarters
                ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => document.getElementById('board-'+q.toLowerCase()).innerHTML = '');
                
                // Allow failed tasks to pass through the filter, but exclude completed ones
                const tasks = app.data.filter(x => x.type !== 'event' && !x.completed && x.deadline >= '2026-01-01' && x.deadline <= '2026-12-31');
                
                tasks.forEach(t => {
                    const month = parseInt(t.deadline.split('-')[1]);
                    let q = '';
                    if (month <= 3) q = 'Q1';
                    else if (month <= 6) q = 'Q2';
                    else if (month <= 9) q = 'Q3';
                    else q = 'Q4';
                    
                    const el = document.createElement('div');
                    // Add red styling if the task is failed
                    el.className = `board-card draggable-item ${t.failed ? 'bg-red-50 border-red-200 opacity-80' : ''}`;
                    el.setAttribute('draggable', 'true');
                    el.setAttribute('data-id', t.id);
                    el.addEventListener('dragstart', app.handleDragStart);
                    
                    el.innerHTML = `
                        <div class="font-bold text-xs ${t.failed ? 'text-red-700 line-through' : 'text-slate-700'}">${t.title}</div>
                        ${t.failed ? `<div class="text-[9px] font-bold text-red-600 mt-1 uppercase leading-tight">EXCUSE: ${t.failReason || 'NONE'}</div>` : ''}
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-[9px] ${t.failed ? 'text-red-400' : 'text-slate-400'} font-mono">${t.deadline}</span>
                            <span class="q-tag ${t.failed ? 'bg-red-100 text-red-600 border border-red-200' : ''}">${t.failed ? 'FAILED' : t.priority.toUpperCase()}</span>
                        </div>
                    `;
                    
                    document.getElementById('board-'+q.toLowerCase()).appendChild(el);
                });
            },


            quickAddQuarter: (q) => {
                const map = { 'Q1': '2026-03-31', 'Q2': '2026-06-30', 'Q3': '2026-09-30', 'Q4': '2026-12-31' };
                document.getElementById('modal-overlay').classList.add('open');
                app.setMode('task');
                document.getElementById('inp-id').value=''; 
                document.getElementById('inp-start').value = app.getIST(); 
                document.getElementById('inp-end').value = map[q]; 
                document.getElementById('modal-title').innerText="Plan for " + q;
            },

            handleBoardDrop: (e, targetQ) => {
                e.preventDefault();
                if (app.dragSrcEl) {
                    const id = app.dragSrcEl.getAttribute('data-id');
                    const item = app.data.find(x => x.id === id);
                    if (item) {
                        const map = { 'Q1': '2026-03-31', 'Q2': '2026-06-30', 'Q3': '2026-09-30', 'Q4': '2026-12-31' };
                        item.deadline = map[targetQ];
                        app.save();
                        app.renderQuarterlyBoard();
                    }
                }
            },

            openTaskPreview: (dStr) => {
                app.currPreviewDate = dStr;
                const parts = dStr.split('-'); const d = new Date(parts[0], parts[1]-1, parts[2]);
                document.getElementById('prev-date-num').innerText = d.getDate(); 
                document.getElementById('prev-date-day').innerText = d.toLocaleDateString('en-US',{month:'long',year:'numeric'});
                const list = document.getElementById('preview-list'); list.innerHTML = '';
                const items = app.data.filter(x => x.deadline === dStr); items.sort((a,b)=>(a.type==='event'?-1:1));
                if(items.length===0) list.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">Nothing scheduled.</div>';
                
                items.forEach(t => {
                    const isEv = t.type==='event';
                    list.innerHTML += `
                    <div class="flex items-center gap-3 py-3 border-b border-gray-100 last:border-0">
                        <button onclick="app.previewToggle('${t.id}','${dStr}')" class="w-6 h-6 rounded-full border-2 ${isEv?'bg-indigo-500 border-indigo-500 text-white':(t.completed?'bg-green-500 border-green-500 text-white':'border-slate-300')} flex items-center justify-center transition-all">
                            ${isEv?'<i class="fas fa-calendar text-[10px]"></i>':'<i class="fas fa-check text-[10px]"></i>'}
                        </button>
                        <div class="flex-1">
                            <div class="font-semibold text-slate-800 text-sm ${t.completed?'line-through text-gray-400':''}">${t.title}</div>
                        </div>
                        <button onclick="app.openModal('edit','${t.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:text-blue-500 active:bg-slate-200"><i class="fas fa-pencil-alt text-xs"></i></button>
                    </div>`;
                });
                document.getElementById('preview-overlay').classList.add('active');
            },
            closePreview: (e) => { if(e.target.id === 'preview-overlay') app.forceClosePreview(); }, 
            forceClosePreview: () => { document.getElementById('preview-overlay').classList.remove('active'); app.currPreviewDate = null; },
            previewToggle: (id, dStr) => { app.toggle(id); app.openTaskPreview(dStr); app.renderCalendar(); },

            // --- STREAK LOGIC ---
            getStreaks: (projectId = null) => {
                let targetTasks = [];
                if (projectId) {
                    targetTasks = app.getDeepTasks([projectId]).filter(x => x.completed && x.type !== 'event');
                } else {
                    targetTasks = app.data.filter(x => x.completed && x.type !== 'event');
                }

                const dates = [...new Set(targetTasks.map(x => x.completedAt ? x.completedAt.split('T')[0] : x.deadline))].sort().reverse();
                if(dates.length === 0) return { fire: 0, phod: 0, history: [], phodHistory: [] };
                
                const today = app.getIST();
                
                let fire = 0;
                let current = new Date(today);
                
                const lastActive = dates[0];
                const lastDate = new Date(lastActive);
                const diffTime = Math.abs(current - lastDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (diffDays <= 1) {
                    let checkDate = new Date(lastActive);
                    for (let i = 0; i < dates.length; i++) {
                        const d = new Date(dates[i]);
                        if (checkDate.getTime() === d.getTime()) {
                            fire++;
                            checkDate.setDate(checkDate.getDate() - 1);
                        } else {
                            break;
                        }
                    }
                }

                let phod = 0;
                const tasksByDate = {};
                targetTasks.forEach(t => {
                    const d = t.completedAt ? t.completedAt.split('T')[0] : t.deadline;
                    tasksByDate[d] = (tasksByDate[d] || 0) + 1;
                });
                
                const phodDates = Object.keys(tasksByDate).filter(d => tasksByDate[d] > 1).sort().reverse();
                
                if (phodDates.length > 0) {
                    const lastPhod = new Date(phodDates[0]);
                    const phodDiff = Math.ceil(Math.abs(new Date(today) - lastPhod) / (1000 * 60 * 60 * 24));
                    
                    if (phodDiff <= 1) {
                        let checkPhod = new Date(phodDates[0]);
                        for (let i = 0; i < phodDates.length; i++) {
                            const d = new Date(phodDates[i]);
                            if (checkPhod.getTime() === d.getTime()) {
                                phod++;
                                checkPhod.setDate(checkPhod.getDate() - 1);
                            } else { break; }
                        }
                    }
                }

                return { fire, phod, history: dates, phodHistory: phodDates };
            },

            updateStreakDisplay: () => {
                const s = app.getStreaks();
                document.getElementById('fire-streak-display').innerText = s.fire;
                document.getElementById('streak-fire-count').innerText = s.fire;
                document.getElementById('streak-phod-count').innerText = s.phod;
                
                const list = document.getElementById('streak-history-list');
                list.innerHTML = s.history.slice(0, 5).map(d => `<div class="flex justify-between"><span>${d}</span><span>Completed</span></div>`).join('');
                
                // Update Streak Projects List
                const pList = document.getElementById('streak-project-list');
                pList.innerHTML = '';
                app.streakProjects.forEach(pid => {
                    const proj = app.data.find(x => x.id === pid) || app.programs.find(x => x.id === pid);
                    if(proj) {
                        const ps = app.getStreaks(pid);
                        pList.innerHTML += `<div class="bg-white p-2 rounded-lg border border-slate-100 shadow-sm flex justify-between items-center"><span class="text-xs font-bold text-slate-700 truncate w-32">${proj.name || proj.title}</span><div class="flex gap-2 text-xs font-black"><span class="text-orange-500">ðŸ”¥ ${ps.fire}</span><span class="text-purple-500">ðŸ¥µ ${ps.phod}</span></div></div>`;
                    }
                });
            },

            openStreakModal: () => {
                app.updateStreakDisplay();
                document.getElementById('streak-overlay').classList.add('open');
            },
            
            openAddProjectModal: () => {
                document.getElementById('add-project-modal').classList.add('open');
                const list = document.getElementById('streak-project-selection-list');
                list.innerHTML = '';
                
                // Projects
                list.innerHTML += '<div class="text-[10px] font-bold text-slate-400 uppercase mt-2 mb-1">Projects</div>';
                const projects = app.data.filter(x => !x.parentId && x.type !== 'event');
                if(projects.length === 0) list.innerHTML += '<div class="text-xs text-slate-300 italic mb-2">No projects.</div>';
                projects.forEach(p => {
                    const isAdded = app.streakProjects.includes(p.id);
                    list.innerHTML += `<div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg mb-1"><span class="text-xs font-bold text-slate-700">${p.title}</span><button onclick="app.toggleProjectStreak('${p.id}')" class="text-[10px] font-bold px-2 py-1 rounded ${isAdded ? 'bg-red-100 text-red-500' : 'bg-blue-100 text-blue-500'}">${isAdded ? 'REMOVE' : 'ADD'}</button></div>`;
                });

                // Programs
                list.innerHTML += '<div class="text-[10px] font-bold text-slate-400 uppercase mt-3 mb-1">Programs</div>';
                if(app.programs.length === 0) list.innerHTML += '<div class="text-xs text-slate-300 italic">No programs.</div>';
                app.programs.forEach(p => {
                    const isAdded = app.streakProjects.includes(p.id);
                    list.innerHTML += `<div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg mb-1"><span class="text-xs font-bold text-slate-700">${p.name}</span><button onclick="app.toggleProjectStreak('${p.id}')" class="text-[10px] font-bold px-2 py-1 rounded ${isAdded ? 'bg-red-100 text-red-500' : 'bg-blue-100 text-blue-500'}">${isAdded ? 'REMOVE' : 'ADD'}</button></div>`;
                });
            },
            
            toggleProjectStreak: (id) => {
                if(app.streakProjects.includes(id)) {
                    app.streakProjects = app.streakProjects.filter(x => x !== id);
                } else {
                    app.streakProjects.push(id);
                }
                app.save();
                app.openAddProjectModal(); 
                app.updateStreakDisplay();
            },

            openHealthAnalysis: () => {
                const tasks = app.data.filter(x => x.type !== 'event');
                const total = tasks.length;
                const done = tasks.filter(x => x.completed).length;
                const failed = tasks.filter(x => x.failed).length;
                const pending = total - done - failed;
                
                const rate = total > 0 ? Math.round((done / total) * 100) : 0;
                const failRate = total > 0 ? Math.round((failed / total) * 100) : 0;
                
                // Calculate 7-Day Velocity
                const today = new Date(app.getIST());
                const lastWeek = new Date(today);
                lastWeek.setDate(lastWeek.getDate() - 7);
                const strLastWeek = lastWeek.toLocaleDateString('en-CA');
                
                const recentTasks = tasks.filter(t => t.deadline >= strLastWeek && t.deadline <= app.getIST());
                const recentTotal = recentTasks.length;
                const recentDone = recentTasks.filter(t => t.completed).length;
                const recentRate = recentTotal > 0 ? Math.round((recentDone / recentTotal) * 100) : 0;
                
                // The Brutal Assessment
                let assessment = "";
                if (total === 0) assessment = "<span class='text-slate-500'>No data. You haven't done anything yet.</span>";
                else if (rate >= 80) assessment = "<span class='text-emerald-600'>Lethal execution. You are operating at elite capacity. Do not drop the standard.</span>";
                else if (rate >= 50) assessment = "<span class='text-blue-600'>Acceptable, but you are leaving massive potential on the table. Tighten up your discipline.</span>";
                else assessment = "<span class='text-red-600'>Pathetic output. You are making plans and abandoning them. Stop lying to yourself and do the work.</span>";

                document.getElementById('prev-date-num').innerText = "Vitals";
                document.getElementById('prev-date-day').innerText = "Execution Analysis";
                
                const list = document.getElementById('preview-list');
                list.innerHTML = `
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4 shadow-inner">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">The Reality Check</h3>
                        <p class="text-sm font-bold text-slate-800 leading-relaxed">${assessment}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Lifetime Hit Rate</div>
                            <div class="text-3xl font-black text-slate-800">${rate}%</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">7-Day Velocity</div>
                            <div class="text-3xl font-black ${recentRate >= rate ? 'text-emerald-500' : 'text-orange-500'}">${recentRate}%</div>
                            <div class="text-[9px] font-bold text-slate-400 mt-1">${recentRate >= rate ? 'â†‘ Trending Up' : 'â†“ Slipping'}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-2 mb-4">
                        <div class="bg-slate-50 p-3 rounded-xl text-center border border-slate-200">
                            <div class="text-[9px] font-bold text-slate-500 uppercase">Total</div>
                            <div class="text-sm font-black text-slate-800 mt-1">${total}</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-xl text-center border border-emerald-200">
                            <div class="text-[9px] font-bold text-emerald-600 uppercase">Done</div>
                            <div class="text-sm font-black text-emerald-700 mt-1">${done}</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-xl text-center border border-red-200">
                            <div class="text-[9px] font-bold text-red-600 uppercase">Failed</div>
                            <div class="text-sm font-black text-red-700 mt-1">${failed}</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl text-center border border-blue-200">
                            <div class="text-[9px] font-bold text-blue-600 uppercase">Pending</div>
                            <div class="text-sm font-black text-blue-700 mt-1">${pending}</div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-800 p-4 rounded-xl text-slate-300 text-xs border border-slate-700">
                        <strong class="text-white"><i class="fas fa-skull text-red-500 mr-1"></i> Failure Ratio:</strong> You abandon 1 out of every ${failRate > 0 ? Math.round(100/failRate) : 'âˆž'} tasks you plan.
                    </div>
                `;
                
                document.getElementById('preview-overlay').classList.add('active');
            },


            // --- STATS & CHARTS LOGIC (FIXED & ROBUST) ---
                        openHealthAnalysis: () => {
                const tasks = app.data.filter(x => x.type !== 'event');
                const total = tasks.length;
                const done = tasks.filter(x => x.completed).length;
                const failed = tasks.filter(x => x.failed).length;
                const partial = tasks.filter(x => x.partial).length;
                const pending = total - done - failed - partial;
                
                const rate = total > 0 ? Math.round((done / total) * 100) : 0;
                const failRate = total > 0 ? Math.round((failed / total) * 100) : 0;
                
                // High Priority Math
                const highTotal = tasks.filter(t => t.priority === 'High').length;
                const highDone = tasks.filter(t => t.priority === 'High' && t.completed).length;
                const highRate = highTotal > 0 ? Math.round((highDone / highTotal) * 100) : 0;

                // 7-Day Velocity
                const today = new Date(app.getIST());
                const lastWeek = new Date(today);
                lastWeek.setDate(lastWeek.getDate() - 7);
                const strLastWeek = lastWeek.toLocaleDateString('en-CA');
                
                const recentTasks = tasks.filter(t => t.deadline >= strLastWeek && t.deadline <= app.getIST());
                const recentTotal = recentTasks.length;
                const recentDone = recentTasks.filter(t => t.completed).length;
                const recentRate = recentTotal > 0 ? Math.round((recentDone / recentTotal) * 100) : 0;
                
                // The Brutal Assessment
                let assessment = "";
                if (total === 0) assessment = "<span class='text-slate-500'>No data. You haven't done anything yet.</span>";
                else if (rate >= 80 && highRate >= 80) assessment = "<span class='text-emerald-600'>Lethal execution. You are clearing high-priority targets and operating at elite capacity.</span>";
                else if (rate >= 50 && highRate < 50) assessment = "<span class='text-orange-600'>Fake productivity. You are doing easy tasks to feel busy while avoiding your High Priority work. Eat the frog.</span>";
                else if (rate >= 50) assessment = "<span class='text-blue-600'>Acceptable, but you are leaving massive potential on the table. Tighten up your discipline.</span>";
                else assessment = "<span class='text-red-600'>Pathetic output. You are making plans and abandoning them. Stop lying to yourself and do the work.</span>";

                document.getElementById('prev-date-num').innerText = "Vitals";
                document.getElementById('prev-date-day').innerText = "Execution Analysis";
                
                const list = document.getElementById('preview-list');
                list.innerHTML = `
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4 shadow-inner">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">The Reality Check</h3>
                        <p class="text-sm font-bold text-slate-800 leading-relaxed">${assessment}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden">
                            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">Lifetime Hit Rate</div>
                            <div class="text-3xl font-black text-slate-800">${rate}%</div>
                            <div class="absolute bottom-0 left-0 h-1 bg-blue-500" style="width: ${rate}%"></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden">
                            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1">High-Priority Hits</div>
                            <div class="text-3xl font-black ${highRate >= 80 ? 'text-emerald-500' : (highRate >= 50 ? 'text-orange-500' : 'text-red-500')}">${highRate}%</div>
                            <div class="absolute bottom-0 left-0 h-1 ${highRate >= 80 ? 'bg-emerald-500' : 'bg-red-500'}" style="width: ${highRate}%"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-2 mb-4">
                        <div class="bg-slate-50 p-3 rounded-xl text-center border border-slate-200">
                            <div class="text-[9px] font-bold text-slate-500 uppercase">Total</div>
                            <div class="text-sm font-black text-slate-800 mt-1">${total}</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-xl text-center border border-emerald-200">
                            <div class="text-[9px] font-bold text-emerald-600 uppercase">Done</div>
                            <div class="text-sm font-black text-emerald-700 mt-1">${done}</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-xl text-center border border-red-200">
                            <div class="text-[9px] font-bold text-red-600 uppercase">Failed</div>
                            <div class="text-sm font-black text-red-700 mt-1">${failed}</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-xl text-center border border-orange-200">
                            <div class="text-[9px] font-bold text-orange-600 uppercase">Partial</div>
                            <div class="text-sm font-black text-orange-700 mt-1">${partial}</div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-800 p-4 rounded-xl flex items-center gap-4 text-slate-300 border border-slate-700">
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl shrink-0"><i class="fas fa-chart-line text-blue-400"></i></div>
                        <div>
                            <div class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">7-Day Momentum</div>
                            <div class="text-sm font-bold text-white">Operating at ${recentRate}% efficiency. ${recentRate >= rate ? '<span class="text-emerald-400">Outperforming baseline.</span>' : '<span class="text-red-400">Slipping behind.</span>'}</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('preview-overlay').classList.add('active');
            },

            openLoadAnalysis: () => {
                const today = app.getIST();
                const activeTasks = app.data.filter(x => x.type !== 'event' && !x.completed && !x.failed && !x.partial);
                
                const overdue = activeTasks.filter(t => t.deadline < today).sort((a,b) => new Date(a.deadline) - new Date(b.deadline));
                const dueToday = activeTasks.filter(t => t.deadline === today);
                const upcoming = activeTasks.filter(t => t.deadline > today).sort((a,b) => new Date(a.deadline) - new Date(b.deadline));

                document.getElementById('prev-date-num').innerText = "Active Load";
                document.getElementById('prev-date-day').innerText = "Pending Execution";
                
                const list = document.getElementById('preview-list');
                
                let html = `
                    <div class="grid grid-cols-3 gap-2 mb-6">
                        <div class="bg-red-50 p-3 rounded-xl border border-red-100 text-center">
                            <div class="text-[9px] font-bold text-red-500 uppercase tracking-widest">Overdue</div>
                            <div class="text-2xl font-black text-red-600 mt-1">${overdue.length}</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center">
                            <div class="text-[9px] font-bold text-blue-500 uppercase tracking-widest">Today</div>
                            <div class="text-2xl font-black text-blue-600 mt-1">${dueToday.length}</div>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 text-center">
                            <div class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Upcoming</div>
                            <div class="text-2xl font-black text-slate-700 mt-1">${upcoming.length}</div>
                        </div>
                    </div>
                `;

                if (overdue.length > 0) {
                    html += `<h3 class="font-bold text-red-500 text-xs uppercase tracking-widest mb-2 border-b border-red-100 pb-1"><i class="fas fa-exclamation-circle mr-1"></i> Overdue (Stagnant)</h3>`;
                    html += `<div class="space-y-2 mb-4">`;
                    overdue.forEach(t => {
                        html += `<div class="bg-white p-3 rounded-lg border border-red-200 shadow-sm flex justify-between items-center"><div class="truncate pr-2"><div class="text-xs font-bold text-slate-800 truncate">${t.title}</div><div class="text-[9px] text-red-500 font-mono mt-0.5">Due: ${t.deadline}</div></div><span class="text-[8px] font-bold bg-red-100 text-red-600 px-2 py-1 rounded uppercase">${t.priority}</span></div>`;
                    });
                    html += `</div>`;
                }

                if (dueToday.length > 0) {
                    html += `<h3 class="font-bold text-blue-500 text-xs uppercase tracking-widest mb-2 border-b border-blue-100 pb-1"><i class="fas fa-crosshairs mr-1"></i> Due Today</h3>`;
                    html += `<div class="space-y-2 mb-4">`;
                    dueToday.forEach(t => {
                        html += `<div class="bg-white p-3 rounded-lg border border-blue-200 shadow-sm flex justify-between items-center"><div class="truncate pr-2"><div class="text-xs font-bold text-slate-800 truncate">${t.title}</div></div><span class="text-[8px] font-bold ${t.priority==='High'?'bg-red-100 text-red-600':t.priority==='Medium'?'bg-orange-100 text-orange-600':'bg-blue-100 text-blue-600'} px-2 py-1 rounded uppercase">${t.priority}</span></div>`;
                    });
                    html += `</div>`;
                }

                if (upcoming.length > 0) {
                    html += `<h3 class="font-bold text-slate-500 text-xs uppercase tracking-widest mb-2 border-b border-slate-200 pb-1"><i class="fas fa-calendar-alt mr-1"></i> Upcoming</h3>`;
                    html += `<div class="space-y-2 pb-6">`;
                    upcoming.slice(0, 5).forEach(t => {
                        html += `<div class="bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex justify-between items-center"><div class="truncate pr-2"><div class="text-xs font-bold text-slate-600 truncate">${t.title}</div><div class="text-[9px] text-slate-400 font-mono mt-0.5">Due: ${t.deadline}</div></div><span class="text-[8px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded uppercase">${t.priority}</span></div>`;
                    });
                    if (upcoming.length > 5) {
                        html += `<div class="text-center text-[10px] text-slate-400 font-bold mt-2">+ ${upcoming.length - 5} more tasks scheduled.</div>`;
                    }
                    html += `</div>`;
                }

                if (activeTasks.length === 0) {
                    html += `<div class="text-center py-8 opacity-50"><i class="fas fa-check-circle text-4xl text-slate-300 mb-3"></i><div class="text-sm font-bold text-slate-500">Zero Load</div><div class="text-xs text-slate-400">Your queue is entirely clear.</div></div>`;
                }

                list.innerHTML = html;
                document.getElementById('preview-overlay').classList.add('active');
            },

getAllSubtasks: () => {
                const leaves = [];
                const traverse = (parentId) => {
                    const children = app.data.filter(x => x.parentId === parentId && x.type !== 'event');
                    if (children.length === 0) { const item = app.data.find(x => x.id === parentId); if(item && item.type !== 'event') leaves.push(item); } 
                    else { children.forEach(c => traverse(c.id)); }
                };
                app.data.filter(x => !x.parentId && x.type !== 'event').forEach(t => traverse(t.id));
                return leaves;
            },

            renderStats: () => {
                // --- 1. PRODUCTIVITY SCORE ---
                const tasks = app.data.filter(x => x.type !== 'event');
                const subtasks = app.getAllSubtasks(); 
                const total = tasks.length;
                const done = tasks.filter(x => x.completed).length;
                let health = total > 0 ? Math.round((done / total) * 100) : 0;
                
                document.getElementById('stat-health-text').innerText = health + '%';
                const card = document.getElementById('health-card'); 
                const sub = document.getElementById('stat-health-sub');
                
                // Card Styling
                card.className = "rounded-3xl p-6 text-white shadow-xl bento-wide transition-all duration-500 relative overflow-hidden bg-gradient-to-br";
                if(health >= 80) { card.classList.add('from-emerald-500','to-teal-600','shadow-emerald-500/40'); sub.innerText = "Peak Flow ðŸš€"; }
                else if(health >= 40) { card.classList.add('from-blue-500','to-indigo-600','shadow-blue-500/40'); sub.innerText = "On Track ðŸ‘"; }
                else { card.classList.add('from-slate-600','to-slate-700','shadow-slate-500/40'); sub.innerText = "Let's Grind ðŸ’ª"; }
                
                // Active Load & Prediction (Stripped of failures and partials)
                const activeLoadTasks = tasks.filter(x => !x.completed && !x.failed && !x.partial);
                const activeLoad = activeLoadTasks.length; 
                document.getElementById('stat-active-count').innerText = activeLoad;
                
                if (total > 0 && done > 0) {
                    const first = app.data.length > 0 ? new Date(parseInt(app.data[0].id)) : new Date();
                    const now = new Date();
                    const daysActive = Math.max(1, (now - first)/(1000*60*60*24));
                    const velocity = done / daysActive;
                    
                    if(velocity > 0 && activeLoad > 0) { 
                        const daysLeft = Math.ceil(activeLoad / velocity);
                        const endD = new Date(); endD.setDate(endD.getDate() + daysLeft);
                        document.getElementById('stat-prediction').innerText = endD.toLocaleDateString('en-US',{month:'short',day:'numeric'});
                    } 
                    else if (activeLoad === 0) { document.getElementById('stat-prediction').innerText = "All Done!"; }
                    else { document.getElementById('stat-prediction').innerText = "Stalled"; }
                } else if (total > 0) { document.getElementById('stat-prediction').innerText = "Start Working"; }
                else { document.getElementById('stat-prediction').innerText = "No Tasks"; }

                // --- 2. ROBUST GRAPH DATA GENERATION ---
                
                // A. Determine Date Range (Auto-expand based on tasks)
                // Default range: Today - 5 days to Today + 30 days
                let startD = new Date(); startD.setDate(startD.getDate() - 5);
                let endD = new Date(); endD.setDate(endD.getDate() + 30);

                // Collect all relevant dates from tasks to expand the view if needed
                const taskDates = subtasks.map(t => t.deadline).concat(subtasks.map(t => t.start)).filter(d => d);
                if (taskDates.length > 0) {
                    const minTaskD = new Date(taskDates.sort()[0]);
                    const maxTaskD = new Date(taskDates.sort()[taskDates.length-1]);
                    if (minTaskD < startD) startD = new Date(minTaskD);
                    if (maxTaskD > endD) endD = new Date(maxTaskD);
                    // Add a little padding to the end
                    endD.setDate(endD.getDate() + 7);
                }

                // Create array of date strings (YYYY-MM-DD)
                const dates = [];
                let curr = new Date(startD);
                while (curr <= endD) {
                    dates.push(curr.toLocaleDateString('en-CA'));
                    curr.setDate(curr.getDate() + 1);
                }

                                      // B. Map Data Points (Strictly excludes completed, partial, and failed)
                const crunchData = dates.map(d => {
                    return subtasks.filter(t => {
                        const s = t.start || t.deadline; 
                        // The brutal filter: Only pure, pending active tasks survive.
                        return !t.completed && !t.partial && !t.failed && d >= s && d <= t.deadline;
                    }).length;
                });
         
                // Upgraded Styling: Semi-transparent backgrounds with sharp borders
                const crunchBg = crunchData.map(v => v>=5?'rgba(239,68,68,0.2)':v>=3?'rgba(245,158,11,0.2)':'rgba(59,130,246,0.2)');
                const crunchBorder = crunchData.map(v => v>=5?'#ef4444':v>=3?'#f59e0b':'#3b82f6');
                
                // POPULATE GRAVEYARD
                const graveyard = document.getElementById('graveyard-list');
                if(graveyard) {
                    const failedTasks = app.data.filter(x => x.failed).sort((a,b) => new Date(b.deadline) - new Date(a.deadline));
                    graveyard.innerHTML = '';
                    if(failedTasks.length === 0) graveyard.innerHTML = '<div class="text-xs text-slate-500 italic text-center py-4 font-mono">Empty. Don\'t get comfortable.</div>';
                    else {
                        failedTasks.forEach(t => {
                            graveyard.innerHTML += `
                                <div class="bg-slate-800 p-3 rounded-xl border border-red-900/50 flex flex-col gap-1">
                                    <div class="flex justify-between items-start">
                                        <span class="text-xs font-bold text-slate-300 line-through decoration-red-500 decoration-2">${t.title}</span>
                                        <button onclick="app.reviveTask('${t.id}')" class="text-[9px] font-bold bg-slate-700 hover:bg-slate-600 text-slate-300 px-2 py-1 rounded transition-colors"><i class="fas fa-undo mr-1"></i>REVIVE</button>
                                    </div>
                                    <div class="text-[9px] text-slate-500 font-mono">${t.deadline}</div>
                                    <div class="text-[10px] text-red-400 font-mono bg-red-950/30 p-1.5 rounded inline-block mt-1 border border-red-900/30">
                                        <span class="font-bold text-red-500">EXCUSE:</span> ${t.failReason || 'None provided.'}
                                    </div>
                                </div>`;
                        });
                    }
                }

                // GRAPH DATA INJECTION
                let ap=0, aa=0, af=0; 
                const dp=[], da=[], df=[];
                const todayStr = app.getIST();
                
                dates.forEach(d => { 
                    ap += tasks.filter(t => t.deadline === d).length; 
                    dp.push(ap); 
                    if(d <= todayStr) { 
                        aa += tasks.filter(t => t.completed && (t.completedAt ? t.completedAt.startsWith(d) : t.deadline===d)).length; 
                        da.push(aa); 
                        af += tasks.filter(t => t.failed && t.deadline===d).length;
                        df.push(af);
                    } else {
                        da.push(null); df.push(null);
                    }
                });


                // --- 3. CHART RENDERING (PREMIUM ANALYTICS) ---
                const niceDates = dates.map(d => { const dt = new Date(d); return `${dt.getDate()} ${dt.toLocaleDateString('en-US',{month:'short'})}`; });

                // Premium Tooltips & Grid Lines
                const safeRender = (id, type, dataConfig, customOptions = {}) => {
                    const ctx = document.getElementById(id);
                    if(!ctx) return;
                    if(app.charts[id]) { app.charts[id].destroy(); }
                    app.charts[id] = new Chart(ctx, {
                        type: type,
                        data: dataConfig,
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            animation: { duration: 500, easing: 'easeOutQuart' },
                            interaction: { mode: 'index', intersect: false }, 
                            scales: {
                                x: { display: true, grid: { display: false }, ticks: { font: { size: 9, family: 'Inter', weight: '600' }, color: '#94a3b8', maxTicksLimit: 7 } },
                                y: { display: true, beginAtZero: true, grid: { color: 'rgba(148, 163, 184, 0.15)', drawBorder: false, borderDash: [4, 4] }, ticks: { font: { size: 9, family: 'Inter', weight: '600' }, color: '#94a3b8', stepSize: 1, precision: 0 } }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.95)', titleFont: { size: 11, family: 'Inter', weight: 'bold' }, bodyFont: { size: 11, family: 'Inter' }, padding: 12, cornerRadius: 8, displayColors: true, borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1 }
                            },
                            ...customOptions
                        }
                    });
                };

                const wrapper = document.getElementById('forecast-wrapper');
                if(wrapper) wrapper.style.width = Math.max(dates.length * 32, wrapper.parentElement.offsetWidth) + 'px';

                // Dual-Layer Workload Forecast (Bars + Trendline)
                safeRender('chart-forecast', 'bar', { 
                    labels: niceDates, 
                    datasets: [
                        { type: 'line', label: 'Trend Trajectory', data: crunchData, borderColor: 'rgba(148, 163, 184, 0.4)', borderDash: [4, 4], pointRadius: 0, borderWidth: 2, tension: 0.4 },
                        { type: 'bar', label: 'Active Load', data: crunchData, backgroundColor: crunchBg, borderColor: crunchBorder, borderWidth: 1, borderRadius: {topLeft: 6, topRight: 6, bottomLeft: 0, bottomRight: 0}, barPercentage: 0.5 }
                    ] 
                });
                
                // Enhanced Velocity Chart
                safeRender('chart-velocity', 'line', { 
                    labels: niceDates, 
                    datasets: [ 
                        { label:'Total Scope', data:dp, borderColor:'#94a3b8', borderDash:[4,4], pointRadius:0, borderWidth: 2, tension: 0.4 }, 
                        { label:'Completed', data:da, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.15)', fill:true, pointRadius:0, borderWidth: 2, tension: 0.4 },
                        { label:'Failed/Excuses', data:df, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.15)', fill:true, pointRadius:0, borderWidth: 2, tension: 0.4 }
                    ] 
                });

                app.renderPrograms();

            },

            renderChart: (id, type, data, opts) => { const ctx = document.getElementById(id); if(!ctx) return; if(app.charts[id]) app.charts[id].destroy(); app.charts[id] = new Chart(ctx, {type, data, options: { ...opts, responsive: true, maintainAspectRatio: false }}); },
            
            // --- PROGRAMS ---
            openProgramModal: () => {
                document.getElementById('program-modal-overlay').classList.add('open');
                document.getElementById('prog-name').value = ''; document.getElementById('prog-reward').value = ''; document.getElementById('prog-milestone').value = '100';
                const list = document.getElementById('prog-task-list'); list.innerHTML = '';
                const tasks = app.data.filter(x => x.type !== 'event');
                if(tasks.length === 0) { list.innerHTML = '<div class="text-xs text-slate-400 p-2">No tasks available.</div>'; return; }
                tasks.forEach(t => { list.innerHTML += `<label class="relative block cursor-pointer"><input type="checkbox" name="prog-tasks" value="${t.id}" class="prog-check hidden peer"><div class="flex items-center gap-3 p-2 rounded-lg bg-white border border-slate-200 peer-checked:bg-purple-50 peer-checked:border-purple-500"><div class="flex-1 truncate"><div class="text-xs font-bold text-slate-700 truncate">${t.title}</div><div class="text-[9px] text-slate-400">${t.type}</div></div></div></label>`; });
            },
            handleProgramSave: (e) => {
                e.preventDefault();
                const name = document.getElementById('prog-name').value;
                const reward = document.getElementById('prog-reward').value;
                const milestone = parseInt(document.getElementById('prog-milestone').value);
                const checks = document.querySelectorAll('input[name="prog-tasks"]:checked');
                const taskIds = Array.from(checks).map(c => c.value);
                if(taskIds.length === 0) { alert("Select at least one task!"); return; }
                app.programs.push({ id: Date.now().toString(), name: name, reward: reward, milestone: milestone, taskIds: taskIds });
                localStorage.setItem('zenith_programs', JSON.stringify(app.programs));
                document.getElementById('program-modal-overlay').classList.remove('open'); app.renderStats();
            },
            
            // --- PROGRAM PREVIEW (RESTORED) ---
            openProgramPreview: (id) => {
                const p = app.programs.find(x => x.id === id); if(!p) return;
                const deepTasks = app.getDeepTasks(p.taskIds);
                const total = deepTasks.length;
                const done = deepTasks.filter(x => x.completed).length;
                let health = total>0 ? Math.round((done/total)*100) : 0;
                
                document.getElementById('prev-date-num').innerText = p.name;
                document.getElementById('prev-date-day').innerText = `${done}/${total} Subtasks â€¢ ${health}%`;
                
                const list = document.getElementById('preview-list');
                list.innerHTML = `
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-indigo-50 p-4 rounded-2xl">
                            <div class="text-[10px] font-bold text-indigo-400 uppercase">Productivity</div>
                            <div class="text-3xl font-black text-indigo-700">${health}%</div>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-2xl">
                            <div class="text-[10px] font-bold text-indigo-400 uppercase">Target</div>
                            <div class="text-lg font-bold text-indigo-700 truncate">${p.milestone}%</div>
                        </div>
                    </div>                
                    <div class="bg-white border border-slate-100 p-4 rounded-2xl mb-4 shadow-sm">
                        <div style="height: 120px; position: relative;"><canvas id="chart-prog-velocity"></canvas></div>
                    </div>
                    <h3 class="font-bold text-slate-400 text-xs uppercase tracking-widest mb-2">Included Items</h3>
                    <div class="space-y-2 pb-10">
                        ${deepTasks.map(t => `
                            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <div class="w-4 h-4 rounded-full border-2 ${t.completed?'bg-green-500 border-green-500':'border-slate-300'} flex items-center justify-center">
                                    ${t.completed?'<i class="fas fa-check text-[8px] text-white"></i>':''}
                                </div>
                                <div class="flex-1 truncate">
                                    <div class="text-xs font-bold text-slate-700 truncate ${t.completed?'line-through text-slate-400':''}">${t.title}</div>
                                    <div class="text-[9px] text-slate-400">${t.deadline}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                document.getElementById('preview-overlay').classList.add('active');
                
                // Render Scoped Chart
                const dates = []; let c = new Date(2025, 11, 31); const e = new Date(2026, 2, 15);
                while(c<=e) { dates.push(c.toLocaleDateString('en-CA')); c.setDate(c.getDate()+1); }
                let ap=0, aa=0; const dp=[], da=[];
                dates.forEach(d => { ap += deepTasks.filter(t => t.deadline === d).length; dp.push(ap); if(d <= app.getIST()) { aa += deepTasks.filter(t => t.completed && (t.completedAt ? t.completedAt.startsWith(d) : t.deadline===d)).length; da.push(aa); } });
                setTimeout(() => { app.renderChart('chart-prog-velocity', 'line', { labels: dates.map(d=>d.slice(5)), datasets: [ { label:'Scope', data:dp, borderColor:'rgba(0,0,0,0.2)', borderDash:[3,3], pointRadius:0 }, { label:'Actual', data:da, borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.1)', fill:true, pointRadius:0 } ] }, { scales: {x:{display:false}, y:{display:false}}, plugins:{legend:{display:false}} }); }, 100);
            },

            renderPrograms: () => {
                const container = document.getElementById('programs-list'); container.innerHTML = '';
                if(app.programs.length === 0) { container.innerHTML = '<div class="text-xs text-slate-400 italic p-2 w-full text-center">No active programs.</div>'; return; }
                app.programs.forEach(p => {
                    const deepTasks = app.getDeepTasks(p.taskIds);
                    const total = deepTasks.length; const done = deepTasks.filter(t => t.completed).length;
                    const pct = total === 0 ? 0 : Math.round((done / total) * 100);
                    const isUnlocked = pct >= p.milestone;
                    container.innerHTML += `<div onclick="app.openProgramPreview('${p.id}')" class="min-w-[200px] bg-white border border-slate-200 rounded-2xl p-4 relative snap-start shadow-sm flex flex-col justify-between cursor-pointer active:scale-95 transition-transform"><div><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-slate-700 text-sm truncate w-24">${p.name}</h4><div class="flex items-center gap-1"><button onclick="event.stopPropagation(); app.downloadReport('${p.id}')" class="text-slate-300 hover:text-blue-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-50"><i class="fas fa-file-alt text-xs"></i></button><button onclick="event.stopPropagation(); app.delProgram('${p.id}')" class="text-slate-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-50"><i class="fas fa-trash text-xs"></i></button></div></div><div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden mb-2"><div class="h-full bg-purple-500 transition-all duration-500" style="width: ${pct}%"></div></div><div class="flex justify-between text-[10px] text-slate-400 font-bold mb-3"><span>${pct}% Done</span><span>Goal: ${p.milestone}%</span></div></div><div class="flex items-center gap-2 ${isUnlocked ? 'text-emerald-600' : 'text-slate-400'}"><div class="w-8 h-8 rounded-full ${isUnlocked ? 'bg-emerald-100' : 'bg-slate-100'} flex items-center justify-center text-lg"><i class="fas ${isUnlocked ? 'fa-gift' : 'fa-lock'}"></i></div><div class="flex-1"><div class="text-[9px] font-bold uppercase tracking-wider">Reward</div><div class="text-xs font-bold truncate ${isUnlocked ? 'glorious-text' : ''}">${p.reward}</div></div></div></div>`;
                });
            },
            delProgram: (id) => { if(confirm("Delete Program?")) { app.programs = app.programs.filter(p => p.id !== id); localStorage.setItem('zenith_programs', JSON.stringify(app.programs)); app.renderStats(); } },
            getDeepTasks: (rootIds) => { let leaves = []; const traverse = (id) => { const children = app.data.filter(x => x.parentId === id); if(children.length === 0) { const item = app.data.find(x => x.id === id); if(item && item.type !== 'event') leaves.push(item); } else { children.forEach(c => traverse(c.id)); } }; rootIds.forEach(id => traverse(id)); return [...new Set(leaves)]; },

            // --- REPORT GENERATION (UPDATED WITH RANGES & LOGS) ---
            calculateDateRanges: (dates) => {
                if (!dates || dates.length === 0) return [];
                const sorted = dates.sort((a,b) => new Date(a) - new Date(b));
                const ranges = [];
                let start = sorted[0];
                let prev = sorted[0];
                let count = 1;

                for (let i = 1; i < sorted.length; i++) {
                    const curr = sorted[i];
                    const diff = Math.round((new Date(curr) - new Date(prev)) / (1000*60*60*24));
                    if (diff === 1) {
                        prev = curr;
                        count++;
                    } else {
                        ranges.push({start, end: prev, count});
                        start = curr;
                        prev = curr;
                        count = 1;
                    }
                }
                ranges.push({start, end: prev, count});
                return ranges.reverse(); 
            },

            generateChartImage: (type, data, options) => {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 1200; canvas.height = 600; 
                    document.getElementById('export-canvas-container').appendChild(canvas);
                    const ctx = canvas.getContext('2d');
                    const chart = new Chart(ctx, {
                        type: type,
                        data: data,
                        options: { ...options, responsive: false, animation: false, devicePixelRatio: 2 }
                    });
                    setTimeout(() => {
                        const img = canvas.toDataURL('image/png');
                        chart.destroy(); canvas.remove(); resolve(img);
                    }, 100);
                });
            },

             downloadReport: async (programId = null, projectId = null) => {
                let tasks = [], subtasks = [], title = "PERFORMANCE LOG";
                
                if (programId) {
                    const p = app.programs.find(x => x.id === programId);
                    if (!p) return;
                    title = `${p.name.toUpperCase()} - DOSSIER`;
                    subtasks = app.getDeepTasks(p.taskIds);
                } else if (projectId) {
                    const p = app.data.find(x => x.id === projectId);
                    if (!p) return;
                    title = `${p.title.toUpperCase()} - DOSSIER`;
                    subtasks = app.getDeepTasks([projectId]);
                } else {
                    subtasks = app.getAllSubtasks();
                }

                if(subtasks.length === 0) { alert("No data to generate report."); return; }

                const timestamps = subtasks.map(t => new Date(t.start || t.deadline || t.id).getTime());
                const deadlines = subtasks.map(t => new Date(t.deadline).getTime());
                const minTime = Math.min(...timestamps, Date.now());
                const maxTime = Math.max(...deadlines, Date.now() + 86400000); 
                
                const minDate = new Date(minTime); const maxDate = new Date(maxTime);
                const dates = [];
                for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) { dates.push(new Date(d).toLocaleDateString('en-CA')); }

                const crunchData = dates.map(d => subtasks.filter(t => !t.completed && !t.failed && d >= t.start && d <= t.deadline).length);
                const crunchCols = crunchData.map(v => v>=6?'#ef4444':v>=3?'#f59e0b':'#3b82f6');
                const crunchImg = await app.generateChartImage('bar', 
                    { labels: dates, datasets: [{ data: crunchData, backgroundColor: crunchCols }] }, 
                    { plugins: { legend: { display: false }, title: { display: true, text: 'Workload Forecast', color: '#1e293b', font: {family: 'Courier New', size: 16} } }, scales: { x:{ticks:{color:'#475569'}}, y:{ticks:{color:'#475569'}} } }
                );

                let ap=0, aa=0, af=0; const dp=[], da=[], df=[];
                dates.forEach(d => { 
                    ap += subtasks.filter(t => t.deadline === d).length; dp.push(ap); 
                    if(d <= app.getIST()) { 
                        aa += subtasks.filter(t => t.completed && (t.completedAt ? t.completedAt.startsWith(d) : t.deadline===d)).length; da.push(aa); 
                        af += subtasks.filter(t => t.failed && t.deadline===d).length; df.push(af);
                    } else { da.push(null); df.push(null); } 
                });
                const velocityImg = await app.generateChartImage('line', 
                    { labels: dates, datasets: [ 
                        { label:'Scope', data:dp, borderColor:'gray', borderDash:[5,5] }, 
                        { label:'Actual', data:da, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.2)', fill:true },
                        { label:'Failed', data:df, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.2)', fill:true }
                    ] }, 
                    { plugins: { title: { display: true, text: 'Velocity Burn-Up', color: '#1e293b', font: {family: 'Courier New', size: 16} } }, scales: { x:{ticks:{color:'#475569'}}, y:{ticks:{color:'#475569'}} } }
                );

                let heightImg = null;
                const heightEntries = Object.values(journal.data)
                    .filter(e => e.height && !isNaN(e.height))
                    .sort((a,b) => new Date(a.date) - new Date(b.date));
                
                if (heightEntries.length > 1) {
                    heightImg = await app.generateChartImage('line', 
                        { 
                            labels: heightEntries.map(e => e.date), 
                            datasets: [{ label: 'Height (cm)', data: heightEntries.map(e => e.height), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3 }] 
                        }, 
                        { plugins: { legend: { display: false }, title: { display: true, text: 'Height Growth Trajectory', color: '#1e293b', font: {family: 'Courier New', size: 16} } } }
                    );
                }

                const failedTasksList = app.data.filter(t => {
                    if (!t.failed) return false; 
                    return subtasks.some(st => {
                        let curr = st;
                        while(curr) { if(curr.id === t.id) return true; curr = app.data.find(x => x.id === curr.parentId); }
                        return false;
                    });
                }).sort((a,b) => new Date(b.deadline) - new Date(a.deadline));

                const completed = subtasks.filter(t => t.completed).length;
                const failed = failedTasksList.length; 
                const total = subtasks.length;
                const health = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                const s = app.getStreaks(projectId);
                const fireRanges = app.calculateDateRanges(s.history);
                const phodRanges = app.calculateDateRanges(s.phodHistory);

                const logEntries = Object.keys(journal.data).sort().reverse().map(date => {
                    const e = journal.data[date];
                    let imgRow = '';
                    if (e.images && e.images.length > 0) {
                        imgRow = `<div class="polaroid-container">${e.images.map(src => `<div class="polaroid"><img src="${src}"></div>`).join('')}</div>`;
                    }
                    const schedule = [
                        { label: 'Wake', val: e.wakeup, icon: 'â˜€ï¸' }, { label: 'Bath', val: e.bath, icon: 'ðŸ›' },
                        { label: 'Breakfast', val: e.bf, icon: 'ðŸ³' }, { label: 'Lunch', val: e.lunch, icon: 'ðŸ±' },
                        { label: 'Dinner', val: e.dinner, icon: 'ðŸ½ï¸' }, { label: 'Sleep', val: e.sleep, icon: 'ðŸŒ™' }
                    ].filter(item => item.val);
                    return { date, schedule, study: e.study, height: e.height, exercise: e.exercise, custom: e.custom || {}, note: e.htmlContent || "No detailed intelligence logged for this date.", imgs: imgRow };
                });

                let advice = {};
                if (health < 50) advice = app.adviceBank.low[Math.floor(Math.random()*app.adviceBank.low.length)];
                else if (health < 80) advice = app.adviceBank.medium[Math.floor(Math.random()*app.adviceBank.medium.length)];
                else advice = app.adviceBank.high[Math.floor(Math.random()*app.adviceBank.high.length)];
                
                const pendingHigh = subtasks.filter(t => !t.completed && !t.failed && t.priority === 'High').sort((a,b) => new Date(a.deadline) - new Date(b.deadline));
                const pendingMed = subtasks.filter(t => !t.completed && !t.failed && t.priority === 'Medium').sort((a,b) => new Date(a.deadline) - new Date(b.deadline));
                const pendingLow = subtasks.filter(t => !t.completed && !t.failed && t.priority === 'Low').sort((a,b) => new Date(a.deadline) - new Date(b.deadline));

                const htmlContent = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>${title}</title>
                        <style>
                            @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap');
                            :root { --paper: #f4f1ea; --ink: #1e293b; --red-ink: #991b1b; --blue-ink: #1e3a8a; --green-ink: #166534; --lines: #cbd5e1; }
                            body { font-family: 'Lora', serif; background: #27272a; color: var(--ink); margin: 0; padding: 40px 20px; display: flex; justify-content: center; }
                            
                            /* The Physical Notebook */
                            .notebook { max-width: 900px; width: 100%; background: var(--paper); box-shadow: 20px 20px 60px rgba(0,0,0,0.5), inset -2px 0 10px rgba(0,0,0,0.05); border-radius: 4px 16px 16px 4px; position: relative; overflow: hidden; transform-origin: left center; animation: openBook 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; perspective: 1500px; }
                            @keyframes openBook { 0% { transform: rotateY(-90deg) scale(0.9); opacity: 0; } 100% { transform: rotateY(0deg) scale(1); opacity: 1; } }
                            
                            /* Binder Edge & Holes */
                            .notebook::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 50px; background: linear-gradient(to right, #d1c9b8, #e8e2d2); border-right: 1px solid #c2b8a3; z-index: 10; box-shadow: inset -2px 0 5px rgba(0,0,0,0.1); }
                            .binder-holes { position: absolute; left: 15px; top: 20px; bottom: 20px; width: 20px; display: flex; flex-direction: column; justify-content: space-between; z-index: 11; }
                            .hole { width: 16px; height: 16px; background: #27272a; border-radius: 50%; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.8), 1px 1px 0 rgba(255,255,255,0.5); }
                            
                            /* The Page & Ruled Lines */
                            .page { padding: 50px 50px 60px 80px; position: relative; min-height: 100vh; background-image: repeating-linear-gradient(transparent, transparent 31px, rgba(203, 213, 225, 0.6) 31px, rgba(203, 213, 225, 0.6) 32px); background-attachment: local; line-height: 32px; }
                            .margin-line { position: absolute; left: 90px; top: 0; bottom: 0; width: 2px; background: rgba(220, 38, 38, 0.3); z-index: 1; }
                            
                            /* Typography & Typewriter Effects */
                            h1, h2, h3 { font-family: 'Courier Prime', monospace; text-transform: uppercase; letter-spacing: -0.5px; position: relative; z-index: 2; display: inline-block; background: var(--paper); padding-right: 15px; margin: 0; line-height: 1.2; }
                            h1 { font-size: 32px; font-weight: 700; border-bottom: 3px solid var(--ink); margin-bottom: 10px; padding-top: 10px;}
                            h2 { font-size: 18px; color: var(--blue-ink); margin-top: 40px; margin-bottom: 20px; border-bottom: 1px dashed var(--blue-ink); padding-bottom: 4px; }
                            .typewriter { font-family: 'Courier Prime', monospace; color: var(--slate-600); }
                            
                            /* Stamps & Accents */
                            .date-stamp { position: absolute; top: 30px; right: 40px; border: 2px solid var(--red-ink); color: var(--red-ink); padding: 4px 12px; font-weight: bold; transform: rotate(4deg); border-radius: 4px; font-family: 'Courier Prime', monospace; font-size: 14px; letter-spacing: 1px; z-index: 5; opacity: 0.8; }
                            .stamp-success { border: 2px solid var(--green-ink); color: var(--green-ink); padding: 2px 8px; font-size: 10px; font-weight: bold; transform: rotate(-3deg); display: inline-block; font-family: 'Courier Prime'; }
                            .stamp-fail { border: 2px solid var(--red-ink); color: var(--red-ink); padding: 2px 8px; font-size: 10px; font-weight: bold; transform: rotate(2deg); display: inline-block; font-family: 'Courier Prime'; }
                            
                            /* Data Display */
                            .vitals-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; background: var(--paper); position: relative; z-index: 2; }
                            .vital-box { border: 1px solid var(--ink); padding: 15px; text-align: center; }
                            .vital-val { font-size: 28px; font-weight: 700; font-family: 'Courier Prime', monospace; }
                            .vital-lbl { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
                            
                            /* Attached Photos / Polaroids */
                            .polaroid-container { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px; background: var(--paper); z-index: 2; position: relative; }
                            .polaroid { background: white; padding: 10px 10px 25px 10px; box-shadow: 2px 4px 12px rgba(0,0,0,0.2); transform: rotate(-2deg); transition: transform 0.2s; page-break-inside: avoid; }
                            .polaroid:nth-child(even) { transform: rotate(3deg); }
                            .polaroid img { width: 150px; height: 150px; object-fit: cover; border: 1px solid #e2e8f0; display: block; filter: contrast(1.1) sepia(0.1); }
                            
                            /* Glued-in Charts */
                            .chart-print { background: white; padding: 15px; border: 1px solid #cbd5e1; box-shadow: 1px 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; transform: rotate(0.5deg); position: relative; z-index: 2; page-break-inside: avoid; }
                            .chart-print img { width: 100%; height: auto; display: block; filter: contrast(1.05) grayscale(0.1); }
                            
                            /* Diary Lists */
                            ul { list-style: none; padding: 0; margin: 0; position: relative; z-index: 2; }
                            li { display: flex; align-items: baseline; gap: 10px; margin-bottom: 8px; background: var(--paper); page-break-inside: avoid; }
                            .directive-high { color: var(--red-ink); } .directive-med { color: #b45309; } .directive-low { color: var(--blue-ink); }
                            .diary-note { font-style: italic; font-size: 15px; color: #334155; padding-left: 15px; border-left: 3px solid #cbd5e1; margin-top: 10px; margin-bottom: 20px; line-height: 1.8; background: var(--paper); position: relative; z-index: 2; }
                            
                            /* Intelligence Table */
                            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; position: relative; z-index: 2; background: var(--paper); page-break-inside: auto; }
                            th { text-align: left; font-family: 'Courier Prime', monospace; border-bottom: 2px solid var(--ink); padding: 8px 0; font-size: 12px; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            td { padding: 12px 10px 12px 0; border-bottom: 1px dashed var(--lines); vertical-align: top; }
                            .intel-tag { font-family: 'Courier Prime', monospace; font-size: 11px; background: #e2e8f0; padding: 2px 6px; border-radius: 2px; margin-right: 4px; margin-bottom: 4px; display: inline-block; color: var(--ink); border: 1px solid #cbd5e1; }

                            /* Note content styles inside journal */
                            .note-content h1, .note-content h2 { background: transparent; padding: 0; border: none; margin-top: 10px; font-family: 'Lora', serif; font-weight: bold; text-transform: none; letter-spacing: 0; font-size: 16px; color: var(--ink); }
                            .note-content ul { padding-left: 20px; list-style-type: disc; }

                            /* Floating Print Button */
                            .print-btn { position: fixed; bottom: 30px; right: 30px; background: var(--ink); color: #fff; border: none; padding: 15px 25px; font-family: 'Courier Prime', monospace; font-weight: bold; font-size: 16px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; gap: 10px; transition: transform 0.2s, background 0.2s; }
                            .print-btn:active { transform: scale(0.95); background: #000; }
                            
                            /* A4 Printing Logic */
                            @media print {
                                @page { size: A4; margin: 15mm; }
                                body { background: #fff; padding: 0; display: block; }
                                .notebook { box-shadow: none; border: none; max-width: 100%; border-radius: 0; animation: none; transform: none; }
                                .notebook::before, .binder-holes, .margin-line, .no-print { display: none !important; }
                                .page { padding: 0; background: transparent; min-height: auto; }
                                h1, h2, h3 { background: transparent; }
                                .vitals-grid { background: transparent; }
                                .chart-print, .polaroid { transform: none; box-shadow: none; border: 1px solid #ccc; }
                                .intel-tag { background: transparent; border: 1px solid #000; }
                            }

                            @media (max-width: 600px) { .page { padding: 40px 20px 40px 60px; } .vitals-grid { grid-template-columns: 1fr 1fr; } .margin-line { left: 70px; } .print-btn { bottom: 20px; right: 20px; padding: 12px 20px; font-size: 14px; } }
                        </style>
                    </head>
                    <body>
                        <button class="no-print print-btn" onclick="window.print()">ðŸ–¨ï¸ PRINT DOSSIER</button>
                        <div class="notebook">
                            <div class="binder-holes">
                                <div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div>
                            </div>
                            <div class="page">
                                <div class="margin-line"></div>
                                <div class="date-stamp">FILED: ${app.getIST()}</div>
                                
                                <h1>${title}</h1><br>
                                <span class="typewriter" style="font-size: 12px; background: var(--paper); position: relative; z-index: 2;">SUBJECT: TACTICAL EXECUTION AUDIT</span>
                                
                                <div class="vitals-grid">
                                    <div class="vital-box"><div class="vital-val">${health}%</div><div class="vital-lbl">Hit Rate</div></div>
                                    <div class="vital-box"><div class="vital-val">${total}</div><div class="vital-lbl">Total Obj.</div></div>
                                    <div class="vital-box"><div class="vital-val">${completed}</div><div class="vital-lbl">Cleared</div></div>
                                    <div class="vital-box" style="color: var(--red-ink); border-color: var(--red-ink);"><div class="vital-val">${failed}</div><div class="vital-lbl">Failures</div></div>
                                </div>

                                <h2>I. Momentum & Streaks</h2>
                                <ul>
                                    <li><span class="typewriter">Determination (1+/day):</span> <strong>${s.fire} Days</strong></li>
                                    ${fireRanges.length ? `<li style="padding-left:20px; font-size: 12px; color: var(--slate-600);"><span class="typewriter">Active Blocks:</span> ${fireRanges.map(r => `[${r.start} to ${r.end}]`).join(', ')}</li>` : ''}
                                    
                                    <li style="margin-top: 10px;"><span class="typewriter">Overdrive (2+/day):</span> <strong>${s.phod} Days</strong></li>
                                    ${phodRanges.length ? `<li style="padding-left:20px; font-size: 12px; color: var(--slate-600);"><span class="typewriter">Active Blocks:</span> ${phodRanges.map(r => `[${r.start} to ${r.end}]`).join(', ')}</li>` : ''}
                                </ul>

                                <h2>II. Visual Intelligence</h2>
                                <div class="chart-print"><img src="${crunchImg}" alt="Workload"></div>
                                <div class="chart-print"><img src="${velocityImg}" alt="Velocity"></div>
                                ${heightImg ? `<div class="chart-print"><img src="${heightImg}" alt="Height"></div>` : ''}

                                <h2>III. Strategic Directive</h2>
                                <div class="diary-note" style="border-left-color: var(--blue-ink);">
                                    <strong>PROTOCOL: ${advice.m}</strong><br>
                                    ${advice.s}<br>
                                    <span style="font-family: 'Courier Prime', monospace; font-size: 11px; margin-top: 5px; display: block;">"${advice.q}"</span>
                                </div>

                                <h2>IV. Breaches of Discipline</h2>
                                <ul style="margin-bottom: 20px;">
                                    ${failedTasksList.length ? failedTasksList.map(t => `
                                        <li>
                                            <span class="stamp-fail">ABANDONED</span> 
                                            <span class="typewriter directive-high" style="text-decoration: line-through;">${t.title}</span>
                                        </li>
                                        <li style="padding-left: 70px; font-size: 12px; color: var(--red-ink); font-family: monospace; margin-top: -15px;">
                                            REASON LOGGED: ${t.failReason || 'No excuse provided.'}
                                        </li>
                                    `).join('') : '<li class="typewriter" style="color: var(--green-ink);">Zero breaches detected. Standard maintained.</li>'}
                                </ul>

                                <h2>V. Field Logs & Daily Intelligence</h2>
                                <table>
                                    <tr><th width="15%">Date</th><th width="20%">Metrics</th><th width="20%">Timeline</th><th>Field Notes</th></tr>
                                    ${logEntries.length ? logEntries.map(l => `
                                        <tr>
                                            <td class="typewriter"><strong>${l.date}</strong></td>
                                            <td>
                                                ${l.study ? `<div class="intel-tag">ðŸ“š Study: ${l.study}h</div>` : ''}
                                                ${l.height ? `<div class="intel-tag">ðŸ“ Height: ${l.height}cm</div>` : ''}
                                                ${l.exercise==='Yes' ? `<div class="intel-tag">ðŸ’ª Exercise: Yes</div>` : ''}
                                                ${journal.customMarkers.map(m => l.custom && l.custom[m.id] ? `<div class="intel-tag">${m.icon} ${m.label}: ${l.custom[m.id]}</div>` : '').join('')}
                                            </td>
                                            <td>${l.schedule.map(t => `<div class="intel-tag">${t.icon} ${t.label}: ${t.val}</div>`).join('')}</td>
                                            <td>
                                                <div class="note-content" style="font-size: 13px; font-style: italic; color: var(--slate-600);">${l.note}</div>
                                                ${l.imgs}
                                            </td>
                                        </tr>`).join('') 
                                    : '<tr><td colspan="4" class="typewriter" style="text-align:center;">No intelligence gathered.</td></tr>'}
                                </table>

                                <h2>VI. Active Directives</h2>
                                <div style="background: var(--paper); position: relative; z-index: 2;">
                                    <strong class="directive-high typewriter">>> HIGH PRIORITY TARGETS</strong>
                                    <ul style="margin-bottom: 15px;">${pendingHigh.length ? pendingHigh.map(t => `<li><span class="typewriter">[ ]</span> <span>${t.title} <span class="typewriter" style="font-size: 10px;">(DUE: ${t.deadline})</span></span></li>`).join('') : '<li><span class="typewriter" style="color: var(--slate-600);">No immediate threats.</span></li>'}</ul>
                                    
                                    <strong class="directive-med typewriter">>> SECONDARY TARGETS</strong>
                                    <ul style="margin-bottom: 15px;">${pendingMed.length ? pendingMed.map(t => `<li><span class="typewriter">[ ]</span> <span style="color: #475569;">${t.title}</span></li>`).join('') : '<li><span class="typewriter" style="color: var(--slate-600);">Clear.</span></li>'}</ul>

                                    <strong class="directive-low typewriter">>> BACKGROUND TARGETS</strong>
                                    <ul>${pendingLow.length ? pendingLow.map(t => `<li><span class="typewriter">[ ]</span> <span style="color: #94a3b8;">${t.title}</span></li>`).join('') : '<li><span class="typewriter" style="color: var(--slate-600);">Clear.</span></li>'}</ul>
                                </div>
                                
                                <div style="text-align: center; margin-top: 60px; font-family: 'Courier Prime', monospace; font-weight: bold; font-size: 10px; color: var(--slate-600); position: relative; z-index: 2; background: var(--paper);">
                                    *** END OF DOSSIER ***<br>
                                    COMPILED BY ZENITH CORE
                                </div>
                            </div>
                        </div>
                    </body>
                    </html>`;

                const blob = new Blob([htmlContent], {type: 'text/html;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Field_Ledger_${app.getIST()}.html`; a.click();
            },





            // --- MODALS & NAVIGATION ---
            openSettings: () => document.getElementById('settings-overlay').classList.add('open'),
                        toggleTheme: () => {
                const html = document.documentElement;
                const btn = document.getElementById('theme-toggle-btn');
                
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    localStorage.setItem('zenith_theme', 'light');
                    btn.innerHTML = '<i class="fas fa-moon"></i> Engage Dark Mode';
                    btn.className = 'w-full py-4 mb-3 bg-slate-800 text-slate-100 font-bold rounded-xl flex items-center justify-center gap-2 transition-colors';
                } else {
                    html.classList.add('dark');
                    localStorage.setItem('zenith_theme', 'dark');
                    btn.innerHTML = '<i class="fas fa-sun"></i> Engage Light Mode';
                    btn.className = 'w-full py-4 mb-3 bg-amber-100 text-amber-600 font-bold rounded-xl flex items-center justify-center gap-2 transition-colors';
                }
                
                // Force status bar to match the new theme instantly
                app.updateThemeColor();
            },

            exportData: async () => {
                const backup = {
                    data: app.data, files: app.files, programs: app.programs,
                    fGroups: app.fileGroups, pGroups: app.projectGroups, 
                    streaks: app.streakProjects, journal: journal.data || {},
                    customMarkers: journal.customMarkers || [] // Included custom markers
                };
                const blob = new Blob([JSON.stringify(backup)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `zenith_backup_${app.getIST().replace(/-/g,'')}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            },
            importData: (input) => {
                const file = input.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const b = JSON.parse(e.target.result);
                        if(b.data || b.tasks) { app.data = b.data || b.tasks; await idb.set('zenith_minimal_v1', app.data); }
                        if(b.files) { app.files = b.files; await idb.set('zenith_files', app.files); }
                        if(b.programs) { app.programs = b.programs; await idb.set('zenith_programs', app.programs); }
                        if(b.fGroups) { app.fileGroups = b.fGroups; await idb.set('zenith_file_groups', app.fileGroups); }
                        if(b.pGroups) { app.projectGroups = b.pGroups; await idb.set('zenith_project_groups', app.projectGroups); }
                        if(b.streaks) { app.streakProjects = b.streaks; await idb.set('zenith_streak_projects', app.streakProjects); }
                        if(b.journal) { journal.data = b.journal; await idb.set('zenith_journal', journal.data); }
                        if(b.customMarkers) { journal.customMarkers = b.customMarkers; await idb.set('zenith_custom_markers', journal.customMarkers); }
                        alert('Data Restored Successfully.'); location.reload();
                    } catch(err) { alert('Invalid Backup File.'); }
                }; reader.readAsText(file);
            },
            
            setMode: (m) => { document.getElementById('inp-type').value = m; document.getElementById('field-priority').classList.toggle('hidden', m!=='task'); document.getElementById('field-start').classList.toggle('hidden', m!=='task'); document.getElementById('field-end').classList.toggle('col-span-2', m!=='task'); },
            openModal: (mode, id) => { 
                document.getElementById('modal-overlay').classList.add('open'); 
                app.setMode('task');
                const grpSel = document.getElementById('inp-group'); grpSel.innerHTML = '';
                app.projectGroups.forEach(g => { grpSel.innerHTML += `<option value="${g}">${g}</option>`; });
                const isRoot = !app.currParent; document.getElementById('field-group').classList.toggle('hidden', !isRoot);
                if(mode==='create'){ document.getElementById('inp-id').value=''; document.getElementById('inp-start').value = app.getIST(); document.getElementById('inp-end').value = app.getIST(); document.getElementById('modal-title').innerText="New Item"; } 
                else { const i = app.data.find(x => x.id === id); document.getElementById('inp-id').value = i.id; document.getElementById('inp-title').value = i.title; if(isRoot && i.group) grpSel.value = i.group; if(i.type==='event') app.setMode('event'); else app.setMode('task'); } 
            },
            closeModal: () => document.getElementById('modal-overlay').classList.remove('open'),
            
            handleSave: (e) => { 
                e.preventDefault(); 
                const id=document.getElementById('inp-id').value; 
                const mode=document.getElementById('inp-type').value; 
                const p={title:document.getElementById('inp-title').value, deadline:document.getElementById('inp-end').value}; 
                if(mode==='task'){ p.priority=document.querySelector('input[name="priority"]:checked').value; p.start=document.getElementById('inp-start').value; } 
                else { p.priority='High'; p.start=p.deadline; }
                if(!app.currParent) p.group = document.getElementById('inp-group').value;
                if(id) { const item = app.data.find(x=>x.id===id); Object.assign(item, p); if(mode === 'event') item.type = 'event'; } 
                else { let type=mode; if(mode==='task') type=app.getLevel(app.currParent); app.data.push({id:Date.now().toString(), parentId:app.currParent, completed:false, ...p, type:type}); } 
                app.save(); app.closeModal(); app.renderList(); app.renderCalendar(); app.updateStreakDisplay();
            },

            switchTab: (t) => {
                // Instantly snap scroll to top to prevent cross-tab scroll bleeding
                document.body.scrollTop = 0; 
                document.documentElement.scrollTop = 0;

                document.querySelectorAll('.dock-btn').forEach(b => b.classList.remove('active'));
                ['list','calendar','stats','journal'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
                document.getElementById('btn-'+t).classList.add('active');
                
                // Add a subtle fade-in animation to the view changes
                const targetView = document.getElementById('view-'+t);
                targetView.classList.remove('hidden');
                targetView.animate([{opacity: 0, transform: 'translateY(10px)'}, {opacity: 1, transform: 'translateY(0)'}], {duration: 200, easing: 'cubic-bezier(0.2, 0.8, 0.2, 1)'});
                
                document.getElementById('main-fab').style.display = t === 'list' ? 'flex' : 'none';
                if(t==='list') { app.renderList(); app.renderFiles(); } 
                if(t==='calendar') app.renderCalendar();
                if(t==='stats') app.renderStats();
            }
        };

        app.init();
           
     
    </script>
   <div class="modal-overlay" id="marker-modal" onclick="if(event.target===this) document.getElementById('marker-modal').classList.remove('open')">
    <div class="modal">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-slate-800">Create Marker</h3>
            <button onclick="document.getElementById('marker-modal').classList.remove('open')" class="w-8 h-8 bg-slate-100 rounded-full text-slate-400"><i class="fas fa-times"></i></button>
        </div>
        <form onsubmit="journal.saveNewMarker(event)">
            <div class="mb-4">
                <label class="text-[10px] font-bold text-slate-400 uppercase">Label Name</label>
                <input type="text" id="marker-name" required placeholder="e.g. Meditation" class="w-full p-3 bg-slate-100 rounded-xl mt-1 font-semibold outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Icon (Emoji)</label>
                    <input type="text" id="marker-icon" required placeholder="e.g. ðŸ§˜" class="w-full p-3 bg-slate-100 rounded-xl mt-1 text-center text-lg outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Input Type</label>
                    <select id="marker-type" class="w-full p-3 bg-slate-100 rounded-xl mt-1 text-xs font-bold outline-none">
                        <option value="number">Number</option>
                        <option value="text">Text</option>
                        <option value="time">Time</option>
                        <option value="yesno">Yes/No</option>
                    </select>
                </div>
            </div>
            <div class="mb-5">
                <label class="text-[10px] font-bold text-slate-400 uppercase">Existing Markers (Tap to Delete)</label>
                <div id="existing-markers-list" class="flex flex-wrap gap-2 mt-2 p-2 bg-slate-50 rounded-xl min-h-[50px]"></div>
            </div>
            <button type="submit" class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl shadow-lg shadow-purple-500/30">Save Marker</button>
        </form>
    </div>
</div>



 
</body>
</html>